import 'dart:async';
import 'package:motto_music/database/database.dart';
import 'package:motto_music/services/bilibili/stream_service.dart';
import 'package:motto_music/services/bilibili/audio_cache_service.dart';
import 'package:motto_music/services/bilibili/api_service.dart';
import 'package:media_kit/media_kit.dart';

/// éŸ³é¢‘åŠ è½½æœåŠ¡
/// 
/// è´Ÿè´£æ ¹æ®æ­Œæ›²æ¥æºï¼ˆæœ¬åœ°/Bilibiliï¼‰åŠ è½½ç›¸åº”çš„éŸ³é¢‘èµ„æº
/// 
/// Bilibili æ­Œæ›²æ’­æ”¾æµç¨‹ï¼š
/// 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
/// 2. å¦‚æœç¼“å­˜å­˜åœ¨ï¼šç›´æ¥æ’­æ”¾æœ¬åœ°æ–‡ä»¶
/// 3. å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼šä¸‹è½½åˆ°æœ¬åœ° â†’ æ’­æ”¾
class AudioLoaderService {
  final Player _player;
  final BilibiliAudioCacheService? _cacheService;
  final BilibiliApiService? _apiService;
  
  // é”™è¯¯ç›‘å¬å™¨è®¢é˜…
  StreamSubscription? _errorSubscription;
  
  // å½“å‰æ­£åœ¨æ’­æ”¾çš„ Bilibili æ­Œæ›²ä¿¡æ¯
  String? _currentBvid;
  int? _currentCid;
  bool _hasRetried = false;
  
  // ä¸‹è½½è¿›åº¦å›è°ƒ
  Function(int received, int total)? onDownloadProgress;
  
  AudioLoaderService(
    this._player, {
    BilibiliAudioCacheService? cacheService,
    BilibiliApiService? apiService,
  }) : _cacheService = cacheService,
       _apiService = apiService {
    _setupErrorListener();
  }
  
  /// æš´éœ²ç¼“å­˜æœåŠ¡ç»™å¤–éƒ¨è®¿é—®
  BilibiliAudioCacheService? get cacheService => _cacheService;
  
  /// æ’­æ”¾æ­Œæ›²
  /// 
  /// æ ¹æ®æ­Œæ›²æ¥æºè‡ªåŠ¨å¤„ç†ï¼š
  /// - æœ¬åœ°æ­Œæ›²ï¼šç›´æ¥ä½¿ç”¨æ–‡ä»¶è·¯å¾„
  /// - Bilibili æ­Œæ›²ï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜æˆ–ä¸‹è½½
  Future<void> playSong(Song song, {bool playNow = true}) async {
    if (song.source == 'bilibili') {
      await _playBilibiliSong(song, playNow: playNow);
    } else {
      await _playLocalSong(song, playNow: playNow);
    }
  }
  
  /// æ’­æ”¾æœ¬åœ°æ­Œæ›²
  Future<void> _playLocalSong(Song song, {required bool playNow}) async {
    try {
      await _player.open(
        Media(song.filePath),
        play: playNow,
      );
    } catch (e) {
      print('æ’­æ”¾æœ¬åœ°æ­Œæ›²å¤±è´¥: $e');
      rethrow;
    }
  }
  
  /// æ’­æ”¾ Bilibili æ­Œæ›²
  Future<void> _playBilibiliSong(Song song, {required bool playNow}) async {
    if (_cacheService == null) {
      throw Exception('BilibiliAudioCacheService æœªåˆå§‹åŒ–');
    }
    
    final bvid = song.bvid;
    if (bvid == null) {
      throw Exception('Bilibili æ­Œæ›²ç¼ºå°‘å¿…è¦çš„ bvid');
    }
    
    // è·å– CIDï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä» API è·å–ï¼‰
    int cid;
    if (song.cid == null) {
      if (_apiService == null) {
        throw Exception('BilibiliApiService æœªåˆå§‹åŒ–ï¼Œæ— æ³•è·å– CID');
      }
      
      print('âš ï¸ CID ä¸ºç©ºï¼Œå°è¯•ä»åˆ†Påˆ—è¡¨è·å–');
      print('  - æ­£åœ¨è·å– $bvid çš„åˆ†Påˆ—è¡¨...');
      
      final pages = await _apiService!.getVideoPages(bvid);
      if (pages.isEmpty) {
        throw Exception('è§†é¢‘ $bvid æ²¡æœ‰åˆ†Pä¿¡æ¯');
      }
      
      cid = pages[0].cid;
      print('âœ… ä»åˆ†Påˆ—è¡¨è·å–åˆ° CID: $cid');
      print('  - åˆ†Pæ•°é‡: ${pages.length}');
      print('  - ç¬¬ä¸€Pæ ‡é¢˜: ${pages[0].part}');
      print('  - ç¬¬ä¸€Pæ—¶é•¿: ${pages[0].duration}ç§’');
    } else {
      cid = song.cid!;
    }
    
    // å¦‚æœæ˜¯æ–°æ­Œæ›²ï¼Œé‡ç½®é‡è¯•æ ‡å¿—
    if (_currentBvid != bvid || _currentCid != cid) {
      _hasRetried = false;
    }
    
    _currentBvid = bvid;
    _currentCid = cid;
    
    try {
      print('ğŸµ å‡†å¤‡æ’­æ”¾ Bilibili æ­Œæ›²: ${song.title}');
      print('  - BVID: $bvid');
      print('  - CID: $cid');
      
      // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
      final cachedPath = await _cacheService!.getCachedAudioPath(
        bvid: bvid,
        cid: cid,
        quality: BilibiliAudioQuality.flac,
      );
      
      if (cachedPath != null) {
        // æœ‰ç¼“å­˜ï¼Œç›´æ¥æ’­æ”¾æœ¬åœ°æ–‡ä»¶
        print('âœ… ä½¿ç”¨æœ¬åœ°ç¼“å­˜: $cachedPath');
        await _player.open(
          Media(cachedPath),
          play: playNow,
        );
      } else {
        // æ— ç¼“å­˜ï¼Œè·å–ç›´é“¾ç«‹å³æ’­æ”¾ï¼ŒåŒæ—¶åå°ç¼“å­˜
        print('ğŸ“¡ æ— ç¼“å­˜ï¼Œä½¿ç”¨ç›´é“¾æ’­æ”¾');
        
        // è·å–æµ URL
        final streamService = _cacheService!.streamService;
        final streamInfo = await streamService.getAudioStream(
          bvid: bvid,
          cid: cid,
          quality: BilibiliAudioQuality.flac,
        );
        
        print('ğŸµ æ’­æ”¾ç›´é“¾: ${streamInfo.url.substring(0, 50)}...');
        
        // ç«‹å³æ’­æ”¾æµ URL
        await _player.open(
          Media(
            streamInfo.url,
            httpHeaders: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Referer': 'https://www.bilibili.com',
            },
          ),
          play: playNow,
        );
        
        // å¼‚æ­¥åå°ä¸‹è½½ç¼“å­˜ï¼ˆä¸é˜»å¡æ’­æ”¾ï¼‰
        print('ğŸ”½ å¼€å§‹åå°ç¼“å­˜...');
        _cacheService!.downloadInBackground(
          bvid: bvid,
          cid: cid,
          quality: BilibiliAudioQuality.flac,
        ).then((_) {
          print('âœ… åå°ç¼“å­˜å®Œæˆ: ${song.title}');
        }).catchError((e) {
          print('âš ï¸ åå°ç¼“å­˜å¤±è´¥: $e');
        });
      }
      
    } catch (e) {
      print('æ’­æ”¾ Bilibili æ­Œæ›²å¤±è´¥: $e');
      rethrow;
    }
  }
  
  /// è®¾ç½®ç»Ÿä¸€çš„é”™è¯¯ç›‘å¬å™¨ï¼ˆä»…åœ¨æ„é€ æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
  void _setupErrorListener() {
    _errorSubscription = _player.stream.error.listen((error) async {
      if (error != null && _currentBvid != null && _currentCid != null && !_hasRetried) {
        print('âŒ æ£€æµ‹åˆ°æ’­æ”¾é”™è¯¯: $error');
        await _retryPlayback();
      }
    });
  }
  
  /// æ‰§è¡Œé‡è¯•æ’­æ”¾
  Future<void> _retryPlayback() async {
    if (_hasRetried || _currentBvid == null || _currentCid == null || _cacheService == null) {
      return;
    }
    
    print('ğŸ”„ å°è¯•æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ä¸‹è½½...');
    
    _hasRetried = true;
    
    try {
      // æ¸…é™¤æ­¤æ­Œæ›²çš„æœ¬åœ°ç¼“å­˜
      await _cacheService!.deleteSongCache(
        bvid: _currentBvid!,
        cid: _currentCid!,
      );
      
      // é‡æ–°ä¸‹è½½å¹¶æ’­æ”¾
      final localFilePath = await _cacheService!.getOrDownloadAudio(
        bvid: _currentBvid!,
        cid: _currentCid!,
        quality: BilibiliAudioQuality.flac,
      );
      
      print('âœ… é‡æ–°ä¸‹è½½æˆåŠŸï¼Œå°è¯•æ’­æ”¾');
      
      // é‡æ–°æ’­æ”¾
      await _player.open(
        Media(localFilePath),
        play: true,
      );
      
    } catch (retryError) {
      print('ğŸ’¥ é‡è¯•å¤±è´¥: $retryError');
    }
  }
  
  /// é¢„åŠ è½½æ­Œæ›²
  /// 
  /// å¯¹äº Bilibili æ­Œæ›²ï¼Œå¦‚æœæ— ç¼“å­˜åˆ™æå‰ä¸‹è½½åˆ°æœ¬åœ°
  Future<void> preloadSong(Song song) async {
    if (song.source != 'bilibili' || _cacheService == null) {
      return;
    }
    
    final bvid = song.bvid;
    if (bvid == null) {
      return;
    }
    
    try {
      // è·å– CIDï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä» API è·å–ï¼‰
      int cid;
      if (song.cid == null) {
        if (_apiService == null) {
          print('é¢„åŠ è½½å¤±è´¥: BilibiliApiService æœªåˆå§‹åŒ–');
          return;
        }
        
        final pages = await _apiService!.getVideoPages(bvid);
        if (pages.isEmpty) {
          print('é¢„åŠ è½½å¤±è´¥: è§†é¢‘ $bvid æ²¡æœ‰åˆ†Pä¿¡æ¯');
          return;
        }
        
        cid = pages[0].cid;
      } else {
        cid = song.cid!;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼“å­˜
      final cachedPath = await _cacheService!.getCachedAudioPath(
        bvid: bvid,
        cid: cid,
        quality: BilibiliAudioQuality.flac,
      );
      
      if (cachedPath != null) {
        print('â© é¢„åŠ è½½è·³è¿‡ï¼ˆå·²æœ‰ç¼“å­˜ï¼‰: ${song.title}');
        return;
      }
      
      // æ— ç¼“å­˜ï¼Œåå°ä¸‹è½½
      print('â© é¢„åŠ è½½å¼€å§‹: ${song.title}');
      await _cacheService!.downloadInBackground(
        bvid: bvid,
        cid: cid,
        quality: BilibiliAudioQuality.flac,
      );
      print('âœ… é¢„åŠ è½½å®Œæˆ: ${song.title}');
    } catch (e) {
      print('âš ï¸ é¢„åŠ è½½å¤±è´¥: $e');
      // é¢„åŠ è½½å¤±è´¥ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œåªè®°å½•æ—¥å¿—
    }
  }
  
  /// æ‰¹é‡é¢„åŠ è½½æ­Œæ›²
  Future<void> preloadSongs(List<Song> songs) async {
    for (final song in songs) {
      await preloadSong(song);
    }
  }
  
  /// æ¸…ç†èµ„æº
  void dispose() {
    _errorSubscription?.cancel();
    _currentBvid = null;
    _currentCid = null;
    _hasRetried = false;
  }
}
