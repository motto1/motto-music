name: Local Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for local build
        run: |
          echo "â³ ç­‰å¾…æœ¬åœ°æ„å»ºå®Œæˆ..."
          echo "è¯·åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
          echo ""
          echo "  flutter build apk --split-per-abi --release"
          echo "  flutter build appbundle --release"
          echo ""
          echo "ç„¶åä¸Šä¼ æ„å»ºäº§ç‰©åˆ°æ­¤ Release"
          sleep 10

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Motto Music ${{ steps.version.outputs.version }}

            ### ğŸ“¦ Android å®‰è£…åŒ…

            è¯·ä»æœ¬åœ°æ„å»ºå¹¶ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶ï¼š
            - **arm64-v8a**: é€‚ç”¨äºå¤§å¤šæ•°ç°ä»£ Android è®¾å¤‡ (æ¨è)
            - **armeabi-v7a**: é€‚ç”¨äºè¾ƒæ—§çš„ 32 ä½ Android è®¾å¤‡
            - **x86_64**: é€‚ç”¨äº x86 æ¶æ„è®¾å¤‡ï¼ˆæ¨¡æ‹Ÿå™¨ç­‰ï¼‰
            - **AAB**: Google Play Store å‘å¸ƒåŒ…

            ### ğŸ“ æœ¬åœ°æ„å»ºæ­¥éª¤

            ```bash
            # 1. æ„å»º APK
            flutter build apk --split-per-abi --release

            # 2. æ„å»º AAB
            flutter build appbundle --release

            # 3. ä¸Šä¼ åˆ° Release
            gh release upload ${{ github.ref_name }} \
              build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk \
              build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
              build/app/outputs/flutter-apk/app-x86_64-release.apk \
              build/app/outputs/bundle/release/app-release.aab
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
