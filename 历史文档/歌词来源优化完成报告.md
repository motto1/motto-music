# æ­Œè¯æ¥æºä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå®ç°äº†ä»¥ä¸‹åŠŸèƒ½ä¼˜åŒ–ï¼š
1. **ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ­Œè¯**ï¼šæ­Œæ›²è‡ªå¸¦çš„æ­Œè¯ä¼˜å…ˆæ˜¾ç¤º
2. **æ™ºèƒ½é™çº§ç­–ç•¥**ï¼šæœ¬åœ°æ— æ­Œè¯æ—¶è‡ªåŠ¨ä»ç½‘ç»œè·å–
3. **æ¥æºæ ‡è¯†æ˜¾ç¤º**ï¼šåœ¨UIä¸­æ¸…æ™°æ˜¾ç¤ºæ­Œè¯æ¥æº

---

## ğŸ”§ æ ¸å¿ƒä¿®æ”¹

### 1. æ•°æ®æ¨¡å‹å¢å¼º (`lib/models/lyrics/lyric_models.dart`)

**æ–°å¢å­—æ®µï¼š**
```dart
class ParsedLrc {
  // ... å…¶ä»–å­—æ®µ
  
  /// æ­Œè¯æ¥æºï¼š'local'(æœ¬åœ°/æ•°æ®åº“), 'netease'(ç½‘æ˜“äº‘éŸ³ä¹), 
  ///          'cache'(ç¼“å­˜), 'manual'(æ‰‹åŠ¨ç¼–è¾‘)
  final String source;
  
  const ParsedLrc({
    // ...
    this.source = 'netease',
  });
}
```

**æ¥æºç±»å‹è¯´æ˜ï¼š**
- `local` - æ•°æ®åº“ä¸­çš„æ­Œè¯ï¼ˆæ­Œæ›²è‡ªå¸¦ï¼‰
- `netease` - ä»ç½‘æ˜“äº‘éŸ³ä¹APIè·å–
- `cache` - ä»æœ¬åœ°ç¼“å­˜è¯»å–
- `manual` - ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘

---

### 2. åŠ è½½é€»è¾‘ä¼˜åŒ– (`lib/services/player_provider.dart`)

**æ–°å¢æ™ºèƒ½åŠ è½½é€»è¾‘ï¼š**
```dart
Future<void> loadLyrics({bool forceRefresh = false}) async {
  // ä¼˜å…ˆçº§1: ä½¿ç”¨æ•°æ®åº“æ­Œè¯ï¼ˆå¦‚æœå­˜åœ¨ä¸”æœªå¼ºåˆ¶åˆ·æ–°ï¼‰
  if (!forceRefresh && _currentSong!.lyrics != null && _currentSong!.lyrics!.isNotEmpty) {
    try {
      final parsedLyrics = LyricParser.parseLrc(_currentSong!.lyrics!);
      _currentLyrics = parsedLyrics.copyWith(source: 'local');
      return;
    } catch (e) {
      print('è§£ææ•°æ®åº“æ­Œè¯å¤±è´¥: $eï¼Œå°†ä»ç½‘ç»œè·å–');
      // è§£æå¤±è´¥ï¼Œç»§ç»­ä»ç½‘ç»œè·å–
    }
  }
  
  // ä¼˜å…ˆçº§2: ä»ç¼“å­˜/ç½‘ç»œè·å–
  final lyrics = await lyricService.smartFetchLyrics(music);
  _currentLyrics = lyrics;
}
```

**åŠ è½½ä¼˜å…ˆçº§ï¼š**
1. **æ•°æ®åº“æ­Œè¯** (source: 'local') - å¦‚æœå­˜åœ¨ä¸”æœ‰æ•ˆ
2. **ç¼“å­˜æ­Œè¯** (source: 'cache') - ä¹‹å‰è·å–è¿‡çš„æ­Œè¯
3. **ç½‘ç»œæ­Œè¯** (source: 'netease') - ä»ç½‘æ˜“äº‘éŸ³ä¹è·å–
4. **å¼ºåˆ¶åˆ·æ–°** - è·³è¿‡æ•°æ®åº“ï¼Œç›´æ¥ä»ç½‘ç»œè·å–

---

### 3. æœåŠ¡å±‚æ ‡è®° (`lib/services/lyrics/lyric_service.dart`)

**æ™ºèƒ½è·å–æ ‡è®°ï¼š**
```dart
Future<ParsedLrc> smartFetchLyrics(Song track) async {
  // ä»ç¼“å­˜è¯»å–
  if (await cacheFile.exists()) {
    final cachedLyrics = ParsedLrc.fromJson(json);
    // æ ‡è®°ç¼“å­˜æ¥æºï¼ˆä¿ç•™localå’Œmanualæ ‡è®°ï¼‰
    if (cachedLyrics.source != 'local' && cachedLyrics.source != 'manual') {
      return cachedLyrics.copyWith(source: 'cache');
    }
    return cachedLyrics;
  }
  
  // ä»ç½‘ç»œè·å–å¹¶æ ‡è®°
  final lyrics = await getBestMatchedLyrics(track: track);
  final neteaseeLyrics = lyrics.copyWith(source: 'netease');
  await _saveLyricsToCache(uniqueKey, neteaseeLyrics);
  return neteaseeLyrics;
}
```

**æ‰‹åŠ¨æœç´¢æ ‡è®°ï¼š**
```dart
Future<ParsedLrc> fetchLyrics({...}) async {
  final lyrics = _neteaseApi.parseLyrics(lyricsResponse);
  // æ ‡è®°ä¸ºç½‘æ˜“äº‘æ¥æº
  final neteaseeLyrics = lyrics.copyWith(source: 'netease');
  await saveLyricsToFile(lyrics: neteaseeLyrics, uniqueKey: uniqueKey);
  return neteaseeLyrics;
}
```

---

### 4. UIæ˜¾ç¤ºä¼˜åŒ– (`lib/widgets/lyrics/lyrics_menu.dart`)

**åŠ¨æ€æ¥æºæ˜¾ç¤ºï¼š**
```dart
String getLyricSourceText() {
  if (currentLyrics == null) return 'æš‚æ— æ­Œè¯';
  
  switch (currentLyrics!.source) {
    case 'local':
      return 'æœ¬åœ°æ­Œè¯';
    case 'netease':
      return 'ç½‘æ˜“äº‘éŸ³ä¹';
    case 'cache':
      return 'ç¼“å­˜';
    case 'manual':
      return 'æ‰‹åŠ¨ç¼–è¾‘';
    default:
      return 'æœªçŸ¥æ¥æº';
  }
}

// UIæ˜¾ç¤º
PopupMenuItem(
  enabled: false,
  child: Row(
    children: [
      const Icon(Icons.info_outline, size: 16),
      const SizedBox(width: 8),
      Expanded(
        child: Text(
          'æ¥æºï¼š${getLyricSourceText()}',
          style: const TextStyle(fontSize: 12, color: Colors.grey),
        ),
      ),
    ],
  ),
),
```

---

### 5. æ‰‹åŠ¨ç¼–è¾‘æ ‡è®° (`lib/widgets/lyrics/edit_lyrics_dialog.dart`)

**ä¿å­˜æ—¶æ ‡è®°ä¸ºæ‰‹åŠ¨ç¼–è¾‘ï¼š**
```dart
Future<void> _handleSave() async {
  // ... è§£æå’Œåˆå¹¶é€»è¾‘
  
  // ä¿ç•™åç§»é‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨ç¼–è¾‘
  finalLyrics = finalLyrics.copyWith(
    offset: widget.lyrics.offset,
    source: 'manual',
  );
  
  await lyricService.saveLyricsToFile(
    lyrics: finalLyrics,
    uniqueKey: widget.uniqueKey,
  );
}
```

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ­Œè¯åŠ è½½æµç¨‹

```
æ’­æ”¾æ­Œæ›²
    â†“
æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ï¼Ÿ
    â†“
  å¦ â†’ æ£€æŸ¥æ•°æ®åº“æ­Œè¯
    â†“
  å­˜åœ¨ä¸”æœ‰æ•ˆï¼Ÿ
    â†“
  æ˜¯ â†’ ä½¿ç”¨æœ¬åœ°æ­Œè¯ (source: 'local') âœ…
    â†“
  å¦ â†’ æ£€æŸ¥ç¼“å­˜
    â†“
  å­˜åœ¨ï¼Ÿ
    â†“
  æ˜¯ â†’ ä½¿ç”¨ç¼“å­˜æ­Œè¯ (source: 'cache') âœ…
    â†“
  å¦ â†’ ç½‘ç»œè·å– (source: 'netease') âœ…
```

### æ¥æºä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ¥æº | è§¦å‘æ¡ä»¶ | æ ‡è¯† |
|-------|------|---------|------|
| 1 | æœ¬åœ°æ­Œè¯ | æ•°æ®åº“æœ‰æ­Œè¯ | `local` |
| 2 | ç¼“å­˜æ­Œè¯ | ä¹‹å‰è·å–è¿‡ | `cache` |
| 3 | ç½‘æ˜“äº‘ | é¦–æ¬¡è·å– | `netease` |
| 4 | æ‰‹åŠ¨ç¼–è¾‘ | ç”¨æˆ·ç¼–è¾‘å | `manual` |

### ç”¨æˆ·æ“ä½œ

| æ“ä½œ | ç»“æœæ¥æº | è¯´æ˜ |
|-----|---------|------|
| æ’­æ”¾æ–°æ­Œ | local â†’ cache â†’ netease | æŒ‰ä¼˜å…ˆçº§ï¿½ï¿½ï¿½è½½ |
| æ‰‹åŠ¨æœç´¢ | netease | å¼ºåˆ¶ä»ç½‘æ˜“äº‘è·å– |
| æ‰‹åŠ¨ç¼–è¾‘ | manual | æ ‡è®°ä¸ºæ‰‹åŠ¨ç¼–è¾‘ |
| åˆ·æ–°æ­Œè¯ | netease | è·³è¿‡æœ¬åœ°ï¼Œå¼ºåˆ¶ç½‘ç»œè·å– |
| è°ƒæ•´åç§» | ä¿æŒåŸæ¥æº | ä»…æ›´æ–°åç§»é‡ |

---

## âœ… éªŒè¯ç»“æœ

**Flutter åˆ†æï¼š**
```
âœ… 0 ä¸ªç¼–è¯‘é”™è¯¯ï¼ˆerrorsï¼‰
âš ï¸ 316 ä¸ªä»£ç é£æ ¼å»ºè®®ï¼ˆinfo + warningï¼‰
```

æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥ç¼–è¯‘è¿è¡Œã€‚

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰ï¼š

1. **lib/models/lyrics/lyric_models.dart**
   - æ·»åŠ  `source` å­—æ®µ
   - æ›´æ–° `fromJson`ã€`toJson`ã€`copyWith` æ–¹æ³•

2. **lib/services/player_provider.dart**
   - æ·»åŠ  `import '../utils/lyric_parser.dart'`
   - ä¼˜åŒ– `loadLyrics()` æ–¹æ³•ï¼Œä¼˜å…ˆä½¿ç”¨æ•°æ®åº“æ­Œè¯

3. **lib/services/lyrics/lyric_service.dart**
   - `smartFetchLyrics()` - ä¸ºä¸åŒæ¥æºæ·»åŠ æ ‡è®°
   - `fetchLyrics()` - æ‰‹åŠ¨æœç´¢æ ‡è®°ä¸º netease

4. **lib/widgets/lyrics/lyrics_menu.dart**
   - æ·»åŠ  `getLyricSourceText()` æ–¹æ³•
   - UIæ˜¾ç¤ºæ­Œè¯æ¥æº

5. **lib/widgets/lyrics/edit_lyrics_dialog.dart**
   - ä¿å­˜æ—¶æ ‡è®°ä¸º `manual`

---

## ğŸ‰ ç”¨æˆ·ä½“éªŒæå‡

### ä¼˜åŒ–å‰ï¼š
- âŒ å¿½ç•¥æ­Œæ›²è‡ªå¸¦æ­Œè¯
- âŒ æ€»æ˜¯å°è¯•ç½‘ç»œè·å–
- âŒ ä¸æ˜¾ç¤ºæ­Œè¯æ¥æº
- âŒ æµªè´¹ç½‘ç»œèµ„æº

### ä¼˜åŒ–åï¼š
- âœ… ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ­Œè¯ï¼ˆå³æ—¶æ˜¾ç¤ºï¼‰
- âœ… æ™ºèƒ½é™çº§åˆ°ç½‘ç»œè·å–
- âœ… æ¸…æ™°æ˜¾ç¤ºæ­Œè¯æ¥æº
- âœ… èŠ‚çœç½‘ç»œèµ„æºå’Œæ—¶é—´

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| æœ‰æœ¬åœ°æ­Œè¯ | ç½‘ç»œè¯·æ±‚ | ç›´æ¥è¯»å– | ğŸš€ å³æ—¶æ˜¾ç¤º |
| æ— æœ¬åœ°æ­Œè¯ | ç½‘ç»œè¯·æ±‚ | ç¼“å­˜ â†’ ç½‘ç»œ | ğŸ“¦ å‡å°‘é‡å¤è¯·æ±‚ |
| ç”¨æˆ·ç¼–è¾‘ | æœªæ ‡è®° | manualæ ‡è®° | ğŸ·ï¸ æ˜ç¡®æ¥æº |

---

## ğŸ”® åç»­å»ºè®®

1. **æŒä¹…åŒ–æœ¬åœ°æ­Œè¯**
   - å°†ç½‘ç»œè·å–çš„æ­Œè¯ä¿å­˜åˆ°æ•°æ®åº“
   - å®ç°æœ¬åœ°æ­Œè¯åº“

2. **æ¥æºç®¡ç†**
   - æ·»åŠ è®¾ç½®é€‰é¡¹ï¼šä¼˜å…ˆæœ¬åœ° / æ€»æ˜¯åœ¨çº¿
   - æ­Œè¯æ¥æºç»Ÿè®¡

3. **å¤šæºæ”¯æŒ**
   - æ”¯æŒæ›´å¤šæ­Œè¯æºï¼ˆQQéŸ³ä¹ã€é…·ç‹—ç­‰ï¼‰
   - æ¥æºä¼˜å…ˆçº§é…ç½®

4. **æ­Œè¯è´¨é‡è¯„ä¼°**
   - åŒ¹é…åº¦è¯„åˆ†
   - æ™ºèƒ½é€‰æ‹©æœ€ä½³æ¥æº

---

## ğŸ“ æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ï¼š

1. **æœ¬åœ°æ­Œè¯æµ‹è¯•**
   - [ ] æ’­æ”¾æœ‰æ­Œè¯çš„æ­Œæ›²ï¼ŒéªŒè¯æ˜¾ç¤º"æœ¬åœ°æ­Œè¯"
   - [ ] æ£€æŸ¥æ­Œè¯å†…å®¹æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

2. **ç½‘ç»œè·å–æµ‹è¯•**
   - [ ] æ’­æ”¾æ— æ­Œè¯çš„æ­Œæ›²ï¼ŒéªŒè¯è‡ªåŠ¨ä»ç½‘æ˜“äº‘è·å–
   - [ ] æ£€æŸ¥æ˜¾ç¤º"ç½‘æ˜“äº‘éŸ³ä¹"

3. **ç¼“å­˜æµ‹è¯•**
   - [ ] é‡æ–°æ’­æ”¾ä¹‹å‰è·å–è¿‡æ­Œè¯çš„æ­Œæ›²
   - [ ] éªŒè¯æ˜¾ç¤º"ç¼“å­˜"ï¼ˆé¦–æ¬¡åº”ä¸ºneteaseï¼‰

4. **æ‰‹åŠ¨ç¼–è¾‘æµ‹è¯•**
   - [ ] ç¼–è¾‘æ­Œè¯å¹¶ä¿å­˜
   - [ ] éªŒè¯æ˜¾ç¤º"æ‰‹åŠ¨ç¼–è¾‘"

5. **åˆ·æ–°æµ‹è¯•**
   - [ ] ç‚¹å‡»"é‡æ–°è·å–æ­Œè¯"
   - [ ] éªŒè¯è·³è¿‡æœ¬åœ°ï¼Œä»ç½‘ç»œè·å–

---

**å®Œæˆæ—¥æœŸï¼š** 2025-01-07
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶é€šè¿‡ç¼–è¯‘éªŒè¯
