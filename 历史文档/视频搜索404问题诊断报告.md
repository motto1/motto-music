# è§†é¢‘æœç´¢ -404 é”™è¯¯é—®é¢˜è¯Šæ–­æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥è§†é¢‘é“¾æ¥ `https://www.bilibili.com/video/BV1gq4y167mq/?spm_id_from=333.337.search-card.all.click&vd_source=...` æ—¶:
- **Flutter åº”ç”¨(å·¦ä¾§)**: æ˜¾ç¤º "-404 å•¥éƒ½æœ¨æœ‰" é”™è¯¯
- **BBPlayer(å³ä¾§)**: æ­£å¸¸æ˜¾ç¤ºè§†é¢‘å†…å®¹

## é—®é¢˜åˆ†æ

### 1. BV å·æå–éªŒè¯ âœ…

æµ‹è¯•ç»“æœæ˜¾ç¤º BV å·æå–å®Œå…¨æ­£ç¡®:
```
æå–çš„ BV å·: BV1gq4y167mq
```

### 2. Bilibili API éªŒè¯ âœ…

ç›´æ¥è°ƒç”¨ Bilibili API æµ‹è¯•:
```bash
curl "https://api.bilibili.com/x/web-interface/view?bvid=BV1gq4y167mq"
```

è¿”å›ç»“æœ:
```json
{
  "code": 0,
  "message": "0",
  "data": {
    "bvid": "BV1gq4y167mq",
    "aid": 591703915,
    "title": "ã€é˜¿æ¢“ã€‘ä¼¤æ„Ÿè‹¦æƒ…æ­Œå…¨æ”¶å½•",
    "videos": 200,
    ...
  }
}
```

**ç»“è®º**: API æœ¬èº«å·¥ä½œæ­£å¸¸,è§†é¢‘å­˜åœ¨ä¸”å¯è®¿é—®ã€‚

### 3. ä»£ç é€»è¾‘éªŒè¯ âœ…

URL è§£ææµç¨‹:
1. ç”¨æˆ·è¾“å…¥: `https://www.bilibili.com/video/BV1gq4y167mq/...`
2. URL è§£æå™¨æå– BV å·: `BV1gq4y167mq`
3. è¿”å›ç­–ç•¥: `SearchStrategy.bvid("BV1gq4y167mq")`
4. è·³è½¬åˆ°: `VideoDetailPage(bvid: "BV1gq4y167mq")`

**ç»“è®º**: ä»£ç é€»è¾‘æ­£ç¡®ã€‚

### 4. é…ç½®å¯¹æ¯”

**BBPlayer é…ç½®:**
```typescript
headers: {
  'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 BiliApp/6.66.0',
  'Cookie': cookie,
}
```

**Flutter é…ç½®:**
```dart
headers: {
  'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 BiliApp/6.66.0',
  'Referer': 'https://www.bilibili.com',
  'Cookie': cookie,
}
```

**ç»“è®º**: é…ç½®ä¸€è‡´,Flutter ç”šè‡³å¤šäº† Referer å¤´ã€‚

## å¯èƒ½çš„åŸå› 

### æœ€å¯èƒ½çš„åŸå› :ç½‘ç»œç¯å¢ƒæˆ– Cookie é—®é¢˜

1. **Cookie å¤±æ•ˆæˆ–æœªç™»å½•**
   - Flutter åº”ç”¨å¯èƒ½æ²¡æœ‰æœ‰æ•ˆçš„ Cookie
   - æŸäº› API åœ¨æœªç™»å½•æ—¶å¯èƒ½è¿”å›ä¸åŒçš„é”™è¯¯ç 

2. **ç½‘ç»œç¯å¢ƒå·®å¼‚**
   - Flutter åº”ç”¨å’Œ BBPlayer å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒ
   - ä»£ç†ã€VPN æˆ–é˜²ç«å¢™å¯èƒ½å½±å“ API è®¿é—®

3. **API é™æµ**
   - Bilibili å¯èƒ½å¯¹æŸäº› IP æˆ–è®¾å¤‡è¿›è¡Œé™æµ
   - Flutter åº”ç”¨çš„è¯·æ±‚å¯èƒ½è¢«è¯†åˆ«ä¸ºå¼‚å¸¸æµé‡

## å·²å®æ–½çš„ä¿®å¤

### 1. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡º:

**`lib/services/bilibili/api_client.dart`:**
- è¯·æ±‚ URL å’Œå‚æ•°
- HTTP å“åº”çŠ¶æ€ç 
- API è¿”å›çš„ code å’Œ message

**`lib/services/bilibili/api_service.dart`:**
- è§†é¢‘è¯¦æƒ… API è°ƒç”¨æ—¥å¿—
- åˆ†Påˆ—è¡¨ API è°ƒç”¨æ—¥å¿—
- å“åº”æ•°æ®æ‘˜è¦

**`lib/views/bilibili/video_detail_page.dart`:**
- åŠ è½½å¼€å§‹/æˆåŠŸ/å¤±è´¥æ—¥å¿—
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º

### 2. æ”¹è¿›é”™è¯¯æç¤º

ä¿®æ”¹äº†é”™è¯¯æ¶ˆæ¯,æä¾›æ›´å‹å¥½çš„æç¤º:
```dart
_errorMessage = 'åŠ è½½å¤±è´¥: $e\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
```

## ä¸‹ä¸€æ­¥è°ƒè¯•æ­¥éª¤

### 1. è¿è¡Œåº”ç”¨å¹¶æŸ¥çœ‹æ—¥å¿—

è¿è¡Œ Flutter åº”ç”¨,åœ¨æœç´¢æ¡†è¾“å…¥è§†é¢‘é“¾æ¥,è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º:

```bash
flutter run
```

æŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—:
- `ğŸŒ å‘èµ· GET è¯·æ±‚`
- `ğŸ“¦ API å“åº”: code=xxx`
- `âŒ API è¿”å›é”™è¯¯`

### 2. æ£€æŸ¥ Cookie çŠ¶æ€

åœ¨åº”ç”¨ä¸­æ£€æŸ¥ Cookie æ˜¯å¦æœ‰æ•ˆ:
```dart
final cookie = await _cookieManager.getCookieString();
print('Cookie: $cookie');
```

### 3. å¯¹æ¯”ç½‘ç»œè¯·æ±‚

ä½¿ç”¨æŠ“åŒ…å·¥å…·(å¦‚ Charlesã€Fiddler)å¯¹æ¯”:
- BBPlayer çš„è¯·æ±‚å¤´å’Œå“åº”
- Flutter åº”ç”¨çš„è¯·æ±‚å¤´å’Œå“åº”

### 4. æµ‹è¯•ä¸åŒåœºæ™¯

- åœ¨ WiFi å’Œç§»åŠ¨ç½‘ç»œä¸‹æµ‹è¯•
- æ¸…é™¤åº”ç”¨æ•°æ®åé‡æ–°æµ‹è¯•
- å°è¯•ç™»å½•åå†æµ‹è¯•

## é¢„æœŸç»“æœ

æ·»åŠ æ—¥å¿—å,è¿è¡Œåº”ç”¨æ—¶åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è¾“å‡º:

**æˆåŠŸæƒ…å†µ:**
```
ğŸŒ å‘èµ· GET è¯·æ±‚: /x/web-interface/view
ğŸ“‹ è¯·æ±‚å‚æ•°: {bvid: BV1gq4y167mq}
âœ… è¯·æ±‚æˆåŠŸ: HTTP 200
ğŸ“¦ API å“åº”: code=0, message=0
âœ… è§†é¢‘è¯¦æƒ… API å“åº”æˆåŠŸ
  - è§†é¢‘æ ‡é¢˜: ã€é˜¿æ¢“ã€‘ä¼¤æ„Ÿè‹¦æƒ…æ­Œå…¨æ”¶å½•
  - è§†é¢‘ aid: 591703915
```

**å¤±è´¥æƒ…å†µ:**
```
ğŸŒ å‘èµ· GET è¯·æ±‚: /x/web-interface/view
ğŸ“‹ è¯·æ±‚å‚æ•°: {bvid: BV1gq4y167mq}
âœ… è¯·æ±‚æˆåŠŸ: HTTP 200
ğŸ“¦ API å“åº”: code=-404, message=å•¥éƒ½æœ¨æœ‰
âŒ API è¿”å›é”™è¯¯: code=-404, message=å•¥éƒ½æœ¨æœ‰
```

## æ€»ç»“

é—®é¢˜çš„æ ¹æœ¬åŸå› å¾ˆå¯èƒ½æ˜¯:
1. **Cookie é—®é¢˜**: Flutter åº”ç”¨æœªç™»å½•æˆ– Cookie å¤±æ•ˆ
2. **ç½‘ç»œç¯å¢ƒ**: API è®¿é—®å—é™æˆ–è¢«é™æµ
3. **è®¾å¤‡è¯†åˆ«**: Bilibili è¯†åˆ«å‡ºå¼‚å¸¸è¯·æ±‚å¹¶è¿”å›é”™è¯¯

é€šè¿‡æ·»åŠ çš„è¯¦ç»†æ—¥å¿—,å¯ä»¥å‡†ç¡®å®šä½é—®é¢˜æ‰€åœ¨,ç„¶åé’ˆå¯¹æ€§åœ°è§£å†³ã€‚

## å»ºè®®

1. **ç«‹å³æ‰§è¡Œ**: è¿è¡Œåº”ç”¨å¹¶æŸ¥çœ‹æ—¥å¿—è¾“å‡º
2. **å¦‚æœæ˜¯ Cookie é—®é¢˜**: å¼•å¯¼ç”¨æˆ·ç™»å½•æˆ–åˆ·æ–° Cookie
3. **å¦‚æœæ˜¯ç½‘ç»œé—®é¢˜**: æ·»åŠ é‡è¯•æœºåˆ¶æˆ–æç¤ºç”¨æˆ·åˆ‡æ¢ç½‘ç»œ
4. **å¦‚æœæ˜¯é™æµé—®é¢˜**: æ·»åŠ è¯·æ±‚é—´éš”æˆ–ä½¿ç”¨å¤‡ç”¨ API
