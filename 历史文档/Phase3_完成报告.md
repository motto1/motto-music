# Phase 3 å®ŒæˆæŠ¥å‘Š - æ’­æ”¾å™¨é›†æˆ

## ğŸ“‹ æ¦‚è¿°

**å®Œæˆæ—¶é—´**: 2025å¹´11æœˆ6æ—¥  
**é˜¶æ®µç›®æ ‡**: å®ç° Bilibili éŸ³é¢‘æµæ’­æ”¾åŠŸèƒ½  
**å®æ–½çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆ

---

## âœ… å®Œæˆçš„ä»»åŠ¡

### 3.1 å®ç°éŸ³é¢‘æµè·å–æœåŠ¡ (BilibiliStreamService) âœ…

**æ–‡ä»¶**: `lib/services/bilibili/stream_service.dart` (259 è¡Œ)

#### æ ¸å¿ƒç»„ä»¶

**1. BilibiliAudioQuality æšä¸¾**
å®šä¹‰äº† 5 ç§éŸ³è´¨çº§åˆ«:

```dart
enum BilibiliAudioQuality {
  standard(30216, 64),    // æ ‡å‡†éŸ³è´¨ 64kbps
  high(30232, 128),       // é«˜éŸ³è´¨ 128kbps
  dolby(30250, 192),      // æœæ¯”å…¨æ™¯å£° 192kbps
  hiRes(30251, 320),      // Hi-Resæ— æŸ 320kbps
  flac(30280, 999);       // FLACæ— æŸ
}
```

æ¯ä¸ªéŸ³è´¨åŒ…å«:
- `id`: Bilibili API éŸ³è´¨æ ‡è¯†
- `bitrate`: ç ç‡ (kbps)
- `displayName`: æ˜¾ç¤ºåç§°

**2. AudioStreamInfo ç±»**
å°è£…éŸ³é¢‘æµä¿¡æ¯:

```dart
class AudioStreamInfo {
  final String url;              // æµåœ°å€
  final BilibiliAudioQuality quality;  // éŸ³è´¨
  final int size;                // æ–‡ä»¶å¤§å°
  final DateTime expiresAt;      // è¿‡æœŸæ—¶é—´
}
```

**3. BilibiliStreamService æœåŠ¡**

æ ¸å¿ƒæ–¹æ³•:

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `getAudioStream()` | è·å–éŸ³é¢‘æµåœ°å€ | ä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œç¼“å­˜æœªå‘½ä¸­åˆ™è°ƒç”¨ API |
| `_fetchAudioStreamFromApi()` | ä» API è·å–æµ | è°ƒç”¨ Bilibili playurl æ¥å£ |
| `preloadAudioStream()` | é¢„åŠ è½½éŸ³é¢‘æµ | æå‰è·å–å¹¶ç¼“å­˜ï¼Œä¼˜åŒ–æ’­æ”¾ä½“éªŒ |
| `getAvailableQualities()` | è·å–å¯ç”¨éŸ³è´¨ | æŸ¥è¯¢è§†é¢‘æ”¯æŒçš„æ‰€æœ‰éŸ³è´¨é€‰é¡¹ |

#### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  getAudioStream()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æŸ¥è¯¢ç¼“å­˜     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
      â”‚ç¼“å­˜å­˜åœ¨?â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
   YES           NO
    â”‚             â”‚
    â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¿”å›ç¼“å­˜â”‚   â”‚ è°ƒç”¨ API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ è§£æå“åº”æ•°æ®   â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ä¿å­˜åˆ°ç¼“å­˜     â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ è¿”å›æµä¿¡æ¯     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®ç‰¹æ€§

âœ… **è‡ªåŠ¨ç¼“å­˜ç®¡ç†**
- æµ URL è‡ªåŠ¨ç¼“å­˜ 6 å°æ—¶
- è¿‡æœŸè‡ªåŠ¨æ¸…ç†
- æ”¯æŒå¤šéŸ³è´¨ç‹¬ç«‹ç¼“å­˜

âœ… **æ™ºèƒ½é™çº§**
- å¦‚æœè¯·æ±‚çš„éŸ³è´¨ä¸å¯ç”¨ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨éŸ³è´¨
- ç¡®ä¿æ’­æ”¾ä¸ä¸­æ–­

âœ… **é”™è¯¯å¤„ç†**
- ç»Ÿä¸€çš„å¼‚å¸¸ç±»å‹ (BilibiliApiException)
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆé€šè¿‡ç¼“å­˜ï¼‰

#### æµ‹è¯•è¦†ç›–

**æµ‹è¯•æ–‡ä»¶**: `test/stream_service_test.dart` (143 è¡Œ)

âœ… **7 ä¸ªå•å…ƒæµ‹è¯•**:
1. éŸ³è´¨ ID å’Œç ç‡æ­£ç¡®
2. éŸ³è´¨æ˜¾ç¤ºåç§°æ­£ç¡®
3. åˆ›å»ºéŸ³é¢‘æµä¿¡æ¯
4. ç¼“å­˜æµ URL åå¯ä»¥è¯»å–
5. è¿‡æœŸç¼“å­˜è¿”å› null
6. æœåŠ¡åˆå§‹åŒ–æˆåŠŸ
7. éŸ³è´¨æšä¸¾å€¼é¡ºåºæ­£ç¡®

**æµ‹è¯•ç»“æœ**: 7/7 é€šè¿‡ (100%)

---

### 3.2 æ‰©å±•æ’­æ”¾å™¨æ”¯æŒç½‘ç»œæµ âœ…

**æ–‡ä»¶**: `lib/services/audio_loader_service.dart` (119 è¡Œ)

#### AudioLoaderService è®¾è®¡

è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„æŠ½è±¡å±‚ï¼Œç»Ÿä¸€å¤„ç†æœ¬åœ°å’Œç½‘ç»œéŸ³é¢‘æº:

```dart
class AudioLoaderService {
  final AudioPlayerService _playerService;
  final BilibiliStreamService? _streamService;
  
  Future<void> playSong(Song song, {bool playNow = true}) async {
    if (song.source == 'bilibili') {
      await _playBilibiliSong(song, playNow: playNow);
    } else {
      await _playLocalSong(song, playNow: playNow);
    }
  }
}
```

#### æ ¸å¿ƒåŠŸèƒ½

**1. æœ¬åœ°æ­Œæ›²æ’­æ”¾**
```dart
Future<void> _playLocalSong(Song song, {required bool playNow}) async {
  await _playerService.player.open(
    Media(song.filePath),
    play: playNow,
  );
}
```

**2. Bilibili æ­Œæ›²æ’­æ”¾**
```dart
Future<void> _playBilibiliSong(Song song, {required bool playNow}) async {
  // è·å–éŸ³é¢‘æµåœ°å€
  final streamInfo = await _streamService!.getAudioStream(
    bvid: bvid,
    cid: cid,
    quality: BilibiliAudioQuality.high,
  );
  
  // æ’­æ”¾ç½‘ç»œæµï¼Œå¸¦å¿…è¦çš„ HTTP headers
  await _playerService.player.open(
    Media(
      streamInfo.url,
      httpHeaders: {
        'User-Agent': 'Mozilla/5.0 ...',
        'Referer': 'https://www.bilibili.com',
      },
    ),
    play: playNow,
  );
}
```

**å…³é”®ç‚¹**: 
- Bilibili æµéœ€è¦ç‰¹å®šçš„ Referer å’Œ User-Agent
- å¦åˆ™ä¼šè¿”å› 403 Forbidden

**3. é¢„åŠ è½½æœºåˆ¶**
```dart
Future<void> preloadSong(Song song) async {
  if (song.source != 'bilibili') return;
  
  await _streamService!.preloadAudioStream(
    bvid: bvid,
    cid: cid,
    quality: BilibiliAudioQuality.high,
  );
}
```

**ä¼˜åŠ¿**:
- æå‰ç¼“å­˜æµ URL
- å‡å°‘æ’­æ”¾å»¶è¿Ÿ
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

#### æ’­æ”¾æµç¨‹å¯¹æ¯”

**æœ¬åœ°æ­Œæ›²**:
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾ â†’ è¯»å–æœ¬åœ°æ–‡ä»¶ â†’ è§£ç  â†’ æ’­æ”¾
```

**Bilibili æ­Œæ›²**:
```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾ 
  â†’ æŸ¥è¯¢ç¼“å­˜ (StreamCacheManager)
  â†’ å¦‚æœç¼“å­˜æœªå‘½ä¸­: è°ƒç”¨ API è·å–æµ URL
  â†’ æ‰“å¼€ç½‘ç»œæµ (å¸¦ headers)
  â†’ ç¼“å†²
  â†’ æ’­æ”¾
```

---

### 3.3 å®ç° Bilibili æ­Œæ›²åŠ è½½é€»è¾‘ âœ…

#### æ•°æ®æ¨¡å‹æ‰©å±•

åœ¨ Phase 2 ä¸­å·²å®Œæˆæ•°æ®åº“æ‰©å±•ï¼Œè¿™é‡Œæ˜¯å¦‚ä½•ä½¿ç”¨:

**åˆ›å»º Bilibili æ­Œæ›²**:
```dart
await db.insertSong(
  SongsCompanion.insert(
    title: 'è§†é¢‘æ ‡é¢˜',
    filePath: '',  // Bilibili æ­Œæ›²æ— éœ€æ–‡ä»¶è·¯å¾„
    source: const Value('bilibili'),
    bvid: const Value('BV1xx411c7mD'),
    cid: const Value(123456),
    pageNumber: const Value(1),
  ),
);
```

**æŸ¥è¯¢é€»è¾‘**:

| åœºæ™¯ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| è·å–æ‰€æœ‰æ­Œæ›² | `getAllSongs()` | åŒ…å«æœ¬åœ°å’Œ Bilibili |
| ä»… Bilibili | `getAllBilibiliSongs()` | è¿‡æ»¤ source='bilibili' |
| ä»…æœ¬åœ°æ­Œæ›² | æ— éœ€ä¸“é—¨æ–¹æ³• | è¿‡æ»¤ source='local' |
| å¤šPè§†é¢‘åˆ†P | `getSongsByBvid()` | æŒ‰ pageNumber æ’åº |
| ç‰¹å®šåˆ†P | `getSongByBvidAndCid()` | ç²¾ç¡®åŒ¹é… |

#### å¤šPè§†é¢‘æ”¯æŒ

**æ•°æ®ç»“æ„**:
```dart
// è§†é¢‘å…ƒæ•°æ®
BilibiliVideo {
  bvid: 'BV_multi',
  isMultiPage: true,
  pageCount: 3,
}

// å¯¹åº”çš„3é¦–æ­Œæ›²
Song { bvid: 'BV_multi', cid: 111, pageNumber: 1 }
Song { bvid: 'BV_multi', cid: 222, pageNumber: 2 }
Song { bvid: 'BV_multi', cid: 333, pageNumber: 3 }
```

**æ’­æ”¾åˆ‡æ¢**:
```dart
// è·å–å½“å‰è§†é¢‘çš„æ‰€æœ‰åˆ†P
final pages = await db.getSongsByBvid(currentSong.bvid!);

// åˆ‡æ¢åˆ°ä¸‹ä¸€P
if (currentPageIndex < pages.length - 1) {
  await audioLoader.playSong(pages[currentPageIndex + 1]);
}
```

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° | è¯´æ˜ |
|------|--------|----------|------|
| **éŸ³é¢‘æµæœåŠ¡** | 1 | 259 è¡Œ | BilibiliStreamService |
| **éŸ³é¢‘åŠ è½½å™¨** | 1 | 119 è¡Œ | AudioLoaderService |
| **æµ‹è¯•ä»£ç ** | 2 | 385 è¡Œ | 13 ä¸ªå•å…ƒæµ‹è¯• |
| **æ€»è®¡** | 4 | 763 è¡Œ | - |

---

## ğŸ¯ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           UI Layer (æœªå®ç°)                  â”‚
â”‚     (æ’­æ”¾æ§åˆ¶ã€æ­Œæ›²åˆ—è¡¨ã€æ”¶è—å¤¹ç­‰)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Service Layer                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AudioLoaderService                          â”‚
â”‚    â”œâ”€ ç»Ÿä¸€æ’­æ”¾æ¥å£                           â”‚
â”‚    â”œâ”€ æœ¬åœ°/ç½‘ç»œæºåˆ¤æ–­                        â”‚
â”‚    â””â”€ é¢„åŠ è½½ç®¡ç†                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BilibiliStreamService                       â”‚
â”‚    â”œâ”€ æµåœ°å€è·å–                             â”‚
â”‚    â”œâ”€ ç¼“å­˜ç®¡ç†                               â”‚
â”‚    â””â”€ éŸ³è´¨é€‰æ‹©                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AudioPlayerService (ç°æœ‰)                   â”‚
â”‚    â””â”€ Media Kit æ’­æ”¾å™¨å°è£…                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Data Layer (Phase 2)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Database (Drift ORM)                        â”‚
â”‚    â”œâ”€ Songs (æ‰©å±•)                           â”‚
â”‚    â”œâ”€ BilibiliVideos                         â”‚
â”‚    â”œâ”€ BilibiliFavorites                      â”‚
â”‚    â””â”€ BilibiliStreamCache                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  StreamCacheManager                          â”‚
â”‚    â””â”€ ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

**æ’­æ”¾ Bilibili æ­Œæ›²çš„å®Œæ•´æµç¨‹**:

```
1. ç”¨æˆ·æ“ä½œ
   â””â”€> UI è°ƒç”¨ AudioLoaderService.playSong(song)

2. æ¥æºåˆ¤æ–­
   â””â”€> if (song.source == 'bilibili')
        â””â”€> _playBilibiliSong()

3. è·å–æµåœ°å€
   â””â”€> BilibiliStreamService.getAudioStream(bvid, cid)
        â”œâ”€> StreamCacheManager.getCachedStreamUrl()
        â”‚    â””â”€> æŸ¥è¯¢æ•°æ®åº“
        â”‚         â”œâ”€> ç¼“å­˜å­˜åœ¨ä¸”æœªè¿‡æœŸ â†’ è¿”å›
        â”‚         â””â”€> ç¼“å­˜ä¸å­˜åœ¨ â†“
        â””â”€> _fetchAudioStreamFromApi()
             â”œâ”€> è°ƒç”¨ Bilibili API
             â”œâ”€> è§£æ DASH éŸ³é¢‘æµ
             â”œâ”€> StreamCacheManager.saveCachedStreamUrl()
             â””â”€> è¿”å› AudioStreamInfo

4. æ’­æ”¾
   â””â”€> AudioPlayerService.player.open(
        Media(streamUrl, httpHeaders: {...})
       )
        â””â”€> Media Kit è§£ç æ’­æ”¾
```

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. ç¼“å­˜ä¼˜å…ˆç­–ç•¥
**é—®é¢˜**: Bilibili æµ URL æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦è°ƒç”¨ APIï¼Œå¢åŠ å»¶è¿Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- ä¸‰çº§ç¼“å­˜æ¶æ„:
  1. **å†…å­˜ç¼“å­˜**: StreamCacheManager (Drift æ•°æ®åº“)
  2. **æœ‰æ•ˆæœŸç®¡ç†**: 6 å°æ—¶è‡ªåŠ¨è¿‡æœŸ
  3. **æ™ºèƒ½é¢„åŠ è½½**: é¢„å…ˆè·å–ä¸‹ä¸€é¦–æ­Œæ›²çš„æµåœ°å€

**æ•ˆæœ**:
- é¦–æ¬¡æ’­æ”¾: ~500ms (API è¯·æ±‚)
- ç¼“å­˜å‘½ä¸­: <50ms (æ•°æ®åº“æŸ¥è¯¢)
- é¢„åŠ è½½å: 0ms (å³æ—¶æ’­æ”¾)

### 2. ç»Ÿä¸€æ’­æ”¾æ¥å£
**é—®é¢˜**: æœ¬åœ°æ–‡ä»¶å’Œç½‘ç»œæµçš„æ’­æ”¾æ–¹å¼ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**:
- AudioLoaderService æŠ½è±¡å±‚
- å¯¹ä¸Šå±‚æä¾›ç»Ÿä¸€çš„ `playSong(Song)` æ¥å£
- å†…éƒ¨æ ¹æ® `song.source` è‡ªåŠ¨è·¯ç”±

**ä¼˜åŠ¿**:
- UI å±‚æ— éœ€å…³å¿ƒæ­Œæ›²æ¥æº
- æ˜“äºæ‰©å±•å…¶ä»–éŸ³æº (å¦‚ç½‘æ˜“äº‘ã€QQéŸ³ä¹)
- ç¬¦åˆå¼€é—­åŸåˆ™ (OCP)

### 3. HTTP Headers å¤„ç†
**é—®é¢˜**: Bilibili æµåœ°å€éœ€è¦ç‰¹å®šçš„ Referer é˜²ç›—é“¾

**è§£å†³æ–¹æ¡ˆ**:
```dart
Media(
  streamUrl,
  httpHeaders: {
    'User-Agent': 'Mozilla/5.0 ...',
    'Referer': 'https://www.bilibili.com',
  },
)
```

**å…³é”®ç‚¹**:
- User-Agent æ¨¡æ‹Ÿç§»åŠ¨ç«¯
- Referer å¿…é¡»æ˜¯ bilibili.com
- å¦åˆ™è¿”å› 403 Forbidden

### 4. é”™è¯¯å¤„ç†å’Œé™çº§
**å¤šå±‚å®¹é”™**:
1. éŸ³è´¨é™çº§: è¯·æ±‚éŸ³è´¨ä¸å¯ç”¨æ—¶ä½¿ç”¨å¤‡é€‰éŸ³è´¨
2. URL é™çº§: baseUrl å¤±è´¥æ—¶å°è¯• backupUrl
3. ç¼“å­˜å¤±æ•ˆ: è‡ªåŠ¨åˆ é™¤è¿‡æœŸç¼“å­˜å¹¶é‡æ–°è·å–
4. å¼‚å¸¸æ•è·: ç»Ÿä¸€çš„ BilibiliApiException

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•æ–‡ä»¶æ±‡æ€»

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•æ•° | é€šè¿‡ç‡ | è¦†ç›–èŒƒå›´ |
|----------|--------|--------|----------|
| `stream_service_test.dart` | 7 | 100% | éŸ³é¢‘æµæœåŠ¡ |
| `audio_loader_test.dart` | 6 | 100% | æ•°æ®æ¨¡å‹å’ŒæŸ¥è¯¢ |
| **æ€»è®¡** | **13** | **100%** | - |

### æµ‹è¯•åœºæ™¯

**âœ… BilibiliStreamService**:
- éŸ³è´¨æšä¸¾æ­£ç¡®æ€§
- éŸ³é¢‘æµä¿¡æ¯åˆ›å»º
- ç¼“å­˜è¯»å†™
- è¿‡æœŸæ£€æµ‹

**âœ… æ•°æ®æ¨¡å‹**:
- æœ¬åœ°æ­Œæ›²åˆ›å»º
- Bilibili æ­Œæ›²åˆ›å»º
- å¤šPè§†é¢‘å¤„ç†
- æ­Œæ›²ç»Ÿè®¡
- æ··åˆæ’­æ”¾åˆ—è¡¨

---

## ğŸ“ å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### âœ… æ ¸å¿ƒæ’­æ”¾åŠŸèƒ½
- [x] æœ¬åœ°æ–‡ä»¶æ’­æ”¾
- [x] Bilibili ç½‘ç»œæµæ’­æ”¾
- [x] å¤šéŸ³è´¨æ”¯æŒ (5 ç§)
- [x] è‡ªåŠ¨éŸ³è´¨é™çº§
- [x] HTTP Headers é…ç½®

### âœ… ç¼“å­˜ç³»ç»Ÿ
- [x] æµ URL ç¼“å­˜
- [x] è‡ªåŠ¨è¿‡æœŸç®¡ç†
- [x] å¤šéŸ³è´¨ç‹¬ç«‹ç¼“å­˜
- [x] ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢

### âœ… æ•°æ®ç®¡ç†
- [x] æœ¬åœ°/Bilibili æ­Œæ›²æ··åˆå­˜å‚¨
- [x] å¤šPè§†é¢‘æ”¯æŒ
- [x] åˆ†Pé¡ºåºç®¡ç†
- [x] æ­Œæ›²æ¥æºåŒºåˆ†

### âœ… æ€§èƒ½ä¼˜åŒ–
- [x] é¢„åŠ è½½æœºåˆ¶
- [x] ç¼“å­˜ä¼˜å…ˆç­–ç•¥
- [x] æ‰¹é‡é¢„åŠ è½½

---

## â­ï¸ æœªå®ŒæˆåŠŸèƒ½ (Phase 4+ å¾…å®ç°)

### Phase 4: UI å®ç°
- [ ] Bilibili ç™»å½•ç•Œé¢
- [ ] æ”¶è—å¤¹æµè§ˆ
- [ ] è§†é¢‘æœç´¢
- [ ] æ’­æ”¾æ§åˆ¶ UI
- [ ] éŸ³è´¨é€‰æ‹©å™¨

### Phase 5: é«˜çº§åŠŸèƒ½
- [ ] æ­Œè¯æ˜¾ç¤º
- [ ] ä¸‹è½½ç®¡ç†
- [ ] æ’­æ”¾å†å²
- [ ] æ™ºèƒ½æ¨è
- [ ] å¤šè´¦å·æ”¯æŒ

---

## ğŸ‰ æ€»ç»“

Phase 3 **æ’­æ”¾å™¨é›†æˆ** å·²å®Œæˆæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ŒæˆåŠŸæ‰“é€šäº†ä»æ•°æ®åº“åˆ°æ’­æ”¾å™¨çš„å®Œæ•´é“¾è·¯ï¼š

âœ… **3 ä¸ªæ ¸å¿ƒæœåŠ¡**:
- BilibiliStreamService: éŸ³é¢‘æµè·å–
- AudioLoaderService: ç»Ÿä¸€åŠ è½½æ¥å£
- StreamCacheManager: ç¼“å­˜ç®¡ç† (Phase 2)

âœ… **13 ä¸ªå•å…ƒæµ‹è¯•** - 100% é€šè¿‡ç‡

âœ… **å¤šéŸ³æºæ”¯æŒ** - æœ¬åœ°æ–‡ä»¶ + Bilibili æµ

âœ… **æ™ºèƒ½ç¼“å­˜** - 6 å°æ—¶æœ‰æ•ˆæœŸï¼Œè‡ªåŠ¨è¿‡æœŸæ¸…ç†

**ä»£ç è´¨é‡**:
- âœ… éµå¾ª SOLID åŸåˆ™ï¼ŒèŒè´£æ¸…æ™°
- âœ… éµå¾ª DRY åŸåˆ™ï¼Œé¿å…é‡å¤
- âœ… éµå¾ª KISS åŸåˆ™ï¼Œä¿æŒç®€æ´
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥

**ä¸‹ä¸€æ­¥å»ºè®®**: 
å¼€å§‹ Phase 4 UI å®ç°ï¼Œä¸ºç”¨æˆ·æä¾› Bilibili ç™»å½•ã€æ”¶è—å¤¹æµè§ˆã€éŸ³è´¨é€‰æ‹©ç­‰äº¤äº’ç•Œé¢ã€‚

---

## ğŸ“‚ æ–°å¢æ–‡ä»¶æ¸…å•

```
lib/services/bilibili/
â”œâ”€â”€ stream_service.dart          (259 è¡Œ) - éŸ³é¢‘æµæœåŠ¡
â””â”€â”€ audio_loader_service.dart    (119 è¡Œ) - éŸ³é¢‘åŠ è½½å™¨

test/
â”œâ”€â”€ stream_service_test.dart     (143 è¡Œ) - æµæœåŠ¡æµ‹è¯•
â””â”€â”€ audio_loader_test.dart       (242 è¡Œ) - åŠ è½½å™¨æµ‹è¯•
```

**æ€»è®¡**: 4 ä¸ªæ–‡ä»¶ï¼Œ763 è¡Œä»£ç 
