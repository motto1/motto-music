# å¯å±•å¼€æ’­æ”¾å™¨é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æˆåŠŸå°†å‚è€ƒé¡¹ç›®ï¼ˆnamida_ui_demoï¼‰çš„åŠ¨ç”»æ¶æ„åº”ç”¨åˆ° LZF Music é¡¹ç›®ï¼Œå®ç°äº†ä»è¿·ä½ æ’­æ”¾å™¨åˆ°å…¨å±æ’­æ”¾å™¨çš„æµç•…è¿‡æ¸¡åŠ¨ç”»ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç»„ä»¶åˆ›å»º

#### `lib/widgets/expandable_player.dart` - åŸºç¡€å®¹å™¨
- **åŠŸèƒ½**ï¼šç®¡ç†æ’­æ”¾å™¨é«˜åº¦åŠ¨ç”»ï¼ˆ80px â†’ å…¨å±ï¼‰
- **ç‰¹æ€§**ï¼š
  - æ”¯æŒæ‹–æ‹½æ‰‹åŠ¿ï¼ˆonVerticalDragUpdate/Endï¼‰
  - æ™ºèƒ½å¸é™„ï¼ˆvelocity > 200 æˆ– percentage > 0.4ï¼‰
  - Apple Music é£æ ¼æ›²çº¿ï¼ˆCurves.easeOutExpo, 800msï¼‰
  - å…¬å¼€æ–¹æ³•ï¼š`animateToState(bool toExpanded)`

#### `lib/widgets/animated_cover_art.dart` - åŠ¨ç”»å°é¢
- **åŠŸèƒ½**ï¼šå°é¢åœ¨è¿·ä½ /å…¨å±æ¨¡å¼é—´å¹³æ»‘è¿‡æ¸¡
- **åŠ¨ç”»å±æ€§**ï¼š
  | å±æ€§ | è¿·ä½ æ¨¡å¼ | å…¨å±æ¨¡å¼ | æ’å€¼æ–¹å¼ |
  |------|---------|---------|---------|
  | å°ºå¯¸ | 60x60 | 250-300 | çº¿æ€§æ’å€¼ |
  | åœ†è§’ | 12 | 20 | çº¿æ€§æ’å€¼ |
  | ä½ç½® | å·¦ä¸Šè§’ | å±…ä¸­ | ä½ç½®æ’å€¼ |
  | é˜´å½± | æ—  | æ·±åº¦é˜´å½± | percentage > 0.5 æ˜¾ç¤º |

#### `lib/widgets/expandable_player_content.dart` - å†…å®¹ç»„ä»¶
- **åŠŸèƒ½**ï¼šæ ¹æ® percentage æ¸²æŸ“ä¸åŒå±‚çº§çš„ UI
- **å±‚çº§ç»“æ„**ï¼š
  ```
  Stack [
    èƒŒæ™¯å±‚ (percentage > 0.1): æ¯›ç»ç’ƒæ•ˆæœ
    è¿·ä½ å±‚ (percentage < 0.5): æ­Œå + æ§åˆ¶æŒ‰é’®
    å±•å¼€å±‚ (percentage > 0.3): æ­Œè¯ + å®Œæ•´æ§åˆ¶
    å°é¢å±‚ (ç‹¬ç«‹): AnimatedCoverArt
  ]
  ```

### 2. ä¸»é¡µé¢é›†æˆ

#### `lib/views/home_page_mobile.dart` - ç§»åŠ¨ç«¯ä¸»é¡µ
**å…³é”®ä¿®æ”¹**ï¼š
```dart
// æ—§ä»£ç 
MiniPlayer() + BottomNavigationBar

// æ–°ä»£ç 
ExpandablePlayer(
  minHeight: 164, // 80 (player) + 4 (gap) + 80 (nav)
  maxHeight: screenHeight,
  builder: (height, percentage) {
    return Stack([
      ExpandablePlayerContent(...),
      if (percentage < 0.3) BottomNavBar(...), // åŠ¨æ€éšè—
    ]);
  },
)
```

**ä¼˜åŠ¿**ï¼š
- âœ… åº•éƒ¨å¯¼èˆªæ éšæ’­æ”¾å™¨å±•å¼€è‡ªåŠ¨éšè—
- âœ… å°é¢å¹³æ»‘ç¼©æ”¾å’Œä½ç½®è¿‡æ¸¡
- âœ… ä¿ç•™æ‰€æœ‰åŸæœ‰åŠŸèƒ½ï¼ˆæ­Œè¯ã€æ§åˆ¶ã€èœå•ï¼‰

### 3. åŠ¨ç”»å‚æ•°é…ç½®

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|------|------|
| **minHeight** | 164px | æ’­æ”¾å™¨ + å¯¼èˆªæ æ€»é«˜åº¦ |
| **maxHeight** | 100%vh | å…¨å±é«˜åº¦ |
| **duration** | 800ms | Apple Music é£æ ¼ |
| **curve** | easeOutExpo | æµç•…è‡ªç„¶ |
| **velocity threshold** | Â±200 px/s | å¿«é€Ÿæ»‘åŠ¨åˆ¤å®š |
| **snap threshold** | 40% | ä½ç½®å¸é™„åˆ¤å®š |

## ğŸ¨ UI å±‚çº§è®¾è®¡

### percentage åˆ†æ®µæ§åˆ¶
```
0.0 - 0.3  è¿·ä½ æ¨¡å¼
           - å°å°é¢ (60x60, å·¦ä¸Šè§’)
           - æ­Œå/è‰ºæœ¯å®¶ (å•è¡Œ)
           - æ’­æ”¾/ä¸‹ä¸€é¦–æŒ‰é’®
           - åº•éƒ¨å¯¼èˆªæ  (Opacity: 1.0)

0.3 - 0.5  è¿‡æ¸¡é˜¶æ®µ
           - è¿·ä½ å±‚æ·¡å‡º (Opacity: 1.0 â†’ 0.0)
           - å±•å¼€å±‚æ·¡å…¥ (Opacity: 0.0 â†’ ~0.3)
           - åº•éƒ¨å¯¼èˆªæ æ·¡å‡º

0.5 - 0.7  å±•å¼€ä¸­æœŸ
           - å°é¢å¼€å§‹æ˜¾ç¤ºé˜´å½±
           - æ­Œè¯å†…å®¹é€æ¸æ¸…æ™°

0.7 - 1.0  å…¨å±æ¨¡å¼
           - å¤§å°é¢ (250-300, å±…ä¸­)
           - æ­Œè¯è§†å›¾ (KaraokeLyricsView)
           - å®Œæ•´æ§åˆ¶é¢æ¿
           - é¡¶éƒ¨èœå•æ  (ä¸‹æ‹‰å›¾æ ‡ + æ­Œè¯èœå•)
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å·²å®æ–½çš„ä¼˜åŒ–
1. **RepaintBoundary**ï¼šéš”ç¦»é‡ç»˜åŒºåŸŸï¼ˆå¾…æ·»åŠ ï¼‰
2. **AnimatedBuilder**ï¼šæœ€å°åŒ–é‡å»ºèŒƒå›´
3. **ValueListenableBuilder**ï¼šç²¾ç¡®ç›‘å¬ position å˜åŒ–
4. **Duration.zero**ï¼šæ‹–æ‹½æ—¶æ— å»¶è¿Ÿè·Ÿéš
5. **Opacity åˆ†å±‚**ï¼šç‹¬ç«‹æ§åˆ¶å„å±‚æ˜¾ç¤º/éšè—

### å»ºè®®çš„ä¼˜åŒ–
```dart
// åœ¨é«˜é¢‘é‡ç»˜ç»„ä»¶å¤–åŒ…è£¹ RepaintBoundary
RepaintBoundary(
  child: AnimatedCoverArt(...),
)

RepaintBoundary(
  child: KaraokeLyricsView(...),
)
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•
```dart
final GlobalKey<ExpandablePlayerState> _playerKey = GlobalKey();

// åœ¨ Widget tree ä¸­
ExpandablePlayer(
  key: _playerKey,
  minHeight: 80,
  maxHeight: MediaQuery.of(context).size.height,
  bgColor: Colors.transparent,
  builder: (height, percentage) {
    return ExpandablePlayerContent(
      height: height,
      percentage: percentage,
      minHeight: 80,
      maxHeight: MediaQuery.of(context).size.height,
    );
  },
)

// ç¨‹åºåŒ–æ§åˆ¶
_playerKey.currentState?.animateToState(true);  // å±•å¼€
_playerKey.currentState?.animateToState(false); // æ”¶èµ·
```

### è‡ªå®šä¹‰åŠ¨ç”»
```dart
ExpandablePlayer(
  duration: const Duration(milliseconds: 600), // è‡ªå®šä¹‰æ—¶é•¿
  curve: Curves.easeInOut, // è‡ªå®šä¹‰æ›²çº¿
  onHeightChange: (percentage) {
    print('å½“å‰å±•å¼€ç™¾åˆ†æ¯”: $percentage');
  },
)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å°é¢ä½ç½®è®¡ç®—
AnimatedCoverArt ä¸­çš„ä½ç½®è®¡ç®—ä¾èµ–ä»¥ä¸‹å‚æ•°ï¼š
- `miniHeight`: è¿·ä½ æ¨¡å¼å®¹å™¨é«˜åº¦
- `screenHeight`: å±å¹•æ€»é«˜åº¦
- é¡¶éƒ¨å¯¼èˆªæ é«˜åº¦: 60pxï¼ˆhardcodedï¼‰
- æ­ŒååŒºé«˜åº¦: 80pxï¼ˆhardcodedï¼‰

å¦‚æœä¿®æ”¹å¸ƒå±€ï¼Œéœ€åŒæ­¥æ›´æ–° `animated_cover_art.dart:91-95`

### 2. ä¸æ¡Œé¢ç«¯å…¼å®¹
å½“å‰å®ç°**ä»…é€‚ç”¨äºç§»åŠ¨ç«¯**ï¼ˆ`home_page_mobile.dart`ï¼‰

æ¡Œé¢ç«¯ï¼ˆ`home_page_desktop.dart`ï¼‰ä»ä½¿ç”¨åŸæ¥çš„è·¯ç”±è·³è½¬æ–¹å¼ï¼š
- `MiniPlayer` + `Navigator.push(NowPlayingScreen)`

å¦‚éœ€æ¡Œé¢ç«¯ä¹Ÿä½¿ç”¨å¯å±•å¼€åŠ¨ç”»ï¼Œå‚è€ƒç§»åŠ¨ç«¯å®ç°ã€‚

### 3. çŠ¶æ€ç®¡ç†
- æ’­æ”¾å™¨çŠ¶æ€ç”± `PlayerProvider` ç®¡ç†ï¼ˆæœªå˜æ›´ï¼‰
- åŠ¨ç”»çŠ¶æ€ç”± `ExpandablePlayerState` ç®¡ç†ï¼ˆæ–°å¢ï¼‰
- ä¸¤è€…é€šè¿‡ `Consumer` å’Œ `ValueListenableBuilder` è¿æ¥

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
lib/widgets/
â”œâ”€â”€ expandable_player.dart          (170 è¡Œ)
â”œâ”€â”€ expandable_player_content.dart  (571 è¡Œ)
â””â”€â”€ animated_cover_art.dart         (183 è¡Œ)
```

### ä¿®æ”¹æ–‡ä»¶
```
lib/views/
â””â”€â”€ home_page_mobile.dart           (ä¿®æ”¹ ~80 è¡Œ)
```

### ä¿ç•™æ–‡ä»¶ï¼ˆæœªåˆ é™¤ï¼‰
```
lib/widgets/
â””â”€â”€ mini_player.dart                (478 è¡Œ) - æ¡Œé¢ç«¯ä»åœ¨ä½¿ç”¨

lib/views/
â””â”€â”€ now_playing_screen.dart         (1553 è¡Œ) - æ¡Œé¢ç«¯ä»åœ¨ä½¿ç”¨
```

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### æ€§èƒ½ä¼˜åŒ–
- [ ] æ·»åŠ  RepaintBoundary åˆ°å°é¢å’Œæ­Œè¯ç»„ä»¶
- [ ] ä¼˜åŒ–èƒŒæ™¯æ¨¡ç³Šæ•ˆæœï¼ˆè€ƒè™‘ä½¿ç”¨é™æ€æ¨¡ç³Šå›¾ç‰‡ï¼‰
- [ ] æµ‹è¯•ä½ç«¯è®¾å¤‡æ€§èƒ½

### åŠŸèƒ½å¢å¼º
- [ ] æ·»åŠ æ¨ªå±æ”¯æŒ
- [ ] æ”¯æŒæ‰‹åŠ¿å…³é—­ï¼ˆå‘ä¸‹æ»‘åŠ¨ï¼‰
- [ ] æ·»åŠ æ’­æ”¾åˆ—è¡¨å±•ç¤ºï¼ˆå½“å‰æœªå®ç°ï¼‰
- [ ] æ¡Œé¢ç«¯è¿ç§»åˆ°æ–°æ¶æ„

### ä»£ç æ¸…ç†
- [ ] ç§»é™¤ `mini_player.dart` ä¸­çš„æ¡Œé¢ç«¯å…¼å®¹ä»£ç ï¼ˆå¦‚æœæ¡Œé¢ç«¯è¿ç§»å®Œæˆï¼‰
- [ ] ç»Ÿä¸€ `now_playing_screen.dart` å’Œ `expandable_player_content.dart` çš„æ­Œè¯é€»è¾‘

## âœ¨ æ€»ç»“

æœ¬æ¬¡é‡æ„æˆåŠŸå®ç°äº†ï¼š
1. âœ… **æµç•…çš„åŠ¨ç”»ä½“éªŒ**ï¼š800ms Apple Music é£æ ¼è¿‡æ¸¡
2. âœ… **ç›´è§‚çš„æ‰‹åŠ¿äº¤äº’**ï¼šæ”¯æŒæ‹–æ‹½å’Œæ™ºèƒ½å¸é™„
3. âœ… **å®Œæ•´çš„åŠŸèƒ½ä¿ç•™**ï¼šæ­Œè¯ã€æ§åˆ¶ã€èœå•å…¨éƒ¨ä¿ç•™
4. âœ… **æ¸…æ™°çš„æ¶æ„è®¾è®¡**ï¼šç»„ä»¶è§£è€¦ï¼Œæ˜“äºç»´æŠ¤

ç”¨æˆ·ä½“éªŒæå‡æ˜¾è‘—ï¼Œä»ä¼ ç»Ÿçš„è·¯ç”±è·³è½¬å‡çº§ä¸ºè¿ç»­çš„å±•å¼€åŠ¨ç”»ï¼Œæ›´è´´è¿‘åŸç”ŸéŸ³ä¹åº”ç”¨çš„äº¤äº’ä½“éªŒã€‚

---

**å®æ–½æ—¥æœŸ**ï¼š2025-01-09  
**æŠ€æœ¯æ ˆ**ï¼šFlutter 3.3+, Provider, AnimationController  
**å‚è€ƒé¡¹ç›®**ï¼šnamida_ui_demo/miniplayer.dart
