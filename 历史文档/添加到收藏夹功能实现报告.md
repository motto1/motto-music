# 添加到收藏夹功能实现报告

## 功能概述

实现了在视频详情页点击按钮，将视频添加到Bilibili收藏夹的功能，支持：
1. 添加到已有的在线收藏夹
2. 创建新的在线收藏夹并添加视频

## 修改文件

### 1. `lib/services/bilibili/api_service.dart`

#### 新增API方法

**`createFavorite()` - 创建新收藏夹**
```dart
Future<int> createFavorite({
  required String title,
  String? intro,
  int privacy = 0,
}) async
```
- 调用B站API `/x/v3/fav/folder/add` 创建收藏夹
- 支持设置标题、简介和隐私设置
- 返回新创建的收藏夹ID

**修改 `addToFavorite()` 方法**
- 改用 `postWithCsrf()` 确保CSRF token正确传递

### 2. `lib/views/bilibili/video_detail_page.dart`

#### 修改的方法

**`_showAddToLibraryDialog()` - 显示添加对话框**
- 重构为支持两种操作：选择已有收藏夹 或 创建新收藏夹
- 使用 `_FavoriteDialogResult` 封装返回结果

**新增方法**

**`_createAndAddToFavorite()` - 创建新收藏夹并添加视频**
```dart
Future<void> _createAndAddToFavorite() async
```
流程：
1. 弹出输入对话框，获取收藏夹名称和简介
2. 调用API创建收藏夹
3. 将新收藏夹保存到本地数据库
4. 自动将当前视频添加到新收藏夹

#### 新增组件

**`_FavoriteDialogResult` - 对话框结果类**
- 封装两种返回类型：选择已有收藏夹 或 创建新收藏夹

**`_AddToFavoriteDialog` - 添加到收藏夹对话框**
- 顶部显示"创建新收藏夹"按钮
- 下方列出已添加到音乐库的收藏夹
- 支持点击选择或创建

## 用户操作流程

### 添加到已有收藏夹
1. 在视频详情页点击右上角"添加到音乐库"按钮
2. 在弹出的对话框中选择已有收藏夹
3. 系统调用API将视频添加到该收藏夹
4. 显示成功提示

### 创建新收藏夹并添加
1. 在视频详情页点击右上角"添加到音乐库"按钮
2. 在弹出的对话框中点击"创建新收藏夹"
3. 输入收藏夹名称和简介（可选）
4. 点击"创建"按钮
5. 系统创建收藏夹并自动添加当前视频
6. 新收藏夹自动添加到音乐库
7. 显示成功提示

## API调用

### 创建收藏夹
- **接口**: `POST /x/v3/fav/folder/add`
- **参数**:
  - `title`: 收藏夹名称
  - `intro`: 简介
  - `privacy`: 隐私设置（0=公开，1=私密）
  - `csrf`: CSRF token（自动添加）

### 添加视频到收藏夹
- **接口**: `POST /x/v3/fav/resource/deal`
- **参数**:
  - `rid`: 视频AV号
  - `type`: 资源类型（2=视频）
  - `add_media_ids`: 收藏夹ID
  - `csrf`: CSRF token（自动添加）

## 数据库操作

新创建的收藏夹会自动保存到本地数据库 `BilibiliFavorites` 表：
- `remoteId`: B站收藏夹ID
- `title`: 收藏夹名称
- `description`: 简介
- `isAddedToLibrary`: 设置为 `true`（已添加到音乐库）
- `syncedAt`: 同步时间

## 注意事项

1. **登录状态**: 创建收藏夹和添加视频都需要登录状态
2. **CSRF Token**: 使用 `postWithCsrf()` 自动处理CSRF验证
3. **错误处理**: 所有操作都有完整的错误提示
4. **数据同步**: 新创建的收藏夹会立即显示在音乐库中

## 测试建议

1. 测试添加到已有收藏夹
2. 测试创建新收藏夹（公开/私密）
3. 测试输入验证（空标题）
4. 测试网络错误处理
5. 测试未登录状态的提示

## 后续优化建议

1. 支持批量添加多个视频
2. 支持移除视频从收藏夹
3. 添加收藏夹封面设置
4. 支持修改收藏夹信息
