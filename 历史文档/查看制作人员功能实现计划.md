# æŸ¥çœ‹åˆ¶ä½œäººå‘˜ï¼ˆUPä¸»è§†é¢‘é¡µé¢ï¼‰åŠŸèƒ½å®ç°è®¡åˆ’

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°ä»æ­Œæ›²èœå•è·³è½¬åˆ°UPä¸»è§†é¢‘é¡µé¢ï¼Œå±•ç¤ºè¯¥UPä¸»çš„æ‰€æœ‰æŠ•ç¨¿è§†é¢‘ã€‚

## ğŸ¯ å®ç°ç›®æ ‡

1. âœ… åˆ›å»º UserVideosPage UIç•Œé¢ï¼ˆå·²å®Œæˆï¼‰
2. ğŸ”² æ‰©å±•æ•°æ®æ¨¡å‹ï¼Œå­˜å‚¨UPä¸»ä¿¡æ¯
3. ğŸ”² å®ç°Bilibili APIè·å–UPä¸»è§†é¢‘åˆ—è¡¨
4. ğŸ”² å®Œå–„UserVideosPageçš„æ•°æ®åŠ è½½é€»è¾‘
5. ğŸ”² å®ç°ä»æ”¶è—å¤¹æ­Œæ›²è·³è½¬åˆ°UPä¸»é¡µé¢

## ğŸ“ è¯¦ç»†å®ç°æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®æ¨¡å‹æ‰©å±•

#### 1.1 æ‰©å±• Song æ¨¡å‹
**æ–‡ä»¶ä½ç½®**ï¼š`lib/database/database.dart`

éœ€è¦åœ¨ `songs` è¡¨ä¸­æ·»åŠ å­—æ®µï¼š
```dart
@DataClassName('Song')
class Songs extends Table {
  // ... ç°æœ‰å­—æ®µ ...
  
  // æ–°å¢å­—æ®µ
  IntColumn get uploaderMid => integer().nullable()();  // UPä¸»çš„ç”¨æˆ·ID
  TextColumn get uploaderName => text().nullable()();    // UPä¸»åç§°
  TextColumn get uploaderFace => text().nullable()();    // UPä¸»å¤´åƒURL
}
```

#### 1.2 æ•°æ®åº“è¿ç§»
- åˆ›å»ºæ–°çš„æ•°æ®åº“ç‰ˆæœ¬
- æ·»åŠ è¿ç§»é€»è¾‘ï¼Œä¸ºç°æœ‰æ•°æ®æ·»åŠ é»˜è®¤å€¼

### ç¬¬äºŒé˜¶æ®µï¼šAPIå®ç°

#### 2.1 æ·»åŠ è·å–UPä¸»è§†é¢‘åˆ—è¡¨çš„API
**æ–‡ä»¶ä½ç½®**ï¼š`lib/services/bilibili/api_service.dart`

éœ€è¦å®ç°çš„æ–¹æ³•ï¼š
```dart
/// è·å–UPä¸»çš„æŠ•ç¨¿è§†é¢‘åˆ—è¡¨
/// 
/// [mid] - UPä¸»çš„ç”¨æˆ·ID
/// [page] - é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
/// [pageSize] - æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤30ï¼‰
/// 
/// Returns: è§†é¢‘åˆ—è¡¨
Future<List<BilibiliVideo>> getUploaderVideos({
  required int mid,
  int page = 1,
  int pageSize = 30,
}) async {
  // APIç«¯ç‚¹ï¼šhttps://api.bilibili.com/x/space/wbi/arc/search
  // å‚æ•°ï¼šmid, pn(é¡µç ), ps(æ¯é¡µæ•°é‡), order(æ’åºæ–¹å¼)
  
  // å®ç°æ­¥éª¤ï¼š
  // 1. æ„é€ è¯·æ±‚å‚æ•°
  // 2. å‘é€GETè¯·æ±‚
  // 3. è§£æå“åº”JSON
  // 4. è½¬æ¢ä¸ºBilibiliVideoå¯¹è±¡åˆ—è¡¨
  // 5. å¤„ç†åˆ†é¡µä¿¡æ¯
}
```

**APIæ–‡æ¡£å‚è€ƒ**ï¼š
- ç«¯ç‚¹ï¼š`GET https://api.bilibili.com/x/space/wbi/arc/search`
- å‚æ•°ï¼š
  - `mid`ï¼šUPä¸»IDï¼ˆå¿…éœ€ï¼‰
  - `pn`ï¼šé¡µç 
  - `ps`ï¼šæ¯é¡µæ•°é‡
  - `order`ï¼šæ’åºæ–¹å¼ï¼ˆpubdate=æœ€æ–°å‘å¸ƒï¼‰

#### 2.2 å“åº”æ•°æ®ç»“æ„
```json
{
  "code": 0,
  "message": "0",
  "data": {
    "list": {
      "vlist": [
        {
          "aid": è§†é¢‘ID,
          "bvid": "BVå·",
          "title": "è§†é¢‘æ ‡é¢˜",
          "pic": "å°é¢URL",
          "description": "ç®€ä»‹",
          "duration": æ—¶é•¿(ç§’),
          "pubdate": å‘å¸ƒæ—¶é—´æˆ³,
          "play": æ’­æ”¾é‡,
          "comment": è¯„è®ºæ•°
        }
      ]
    },
    "page": {
      "count": æ€»æ•°,
      "pn": å½“å‰é¡µ,
      "ps": æ¯é¡µæ•°é‡
    }
  }
}
```

### ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå–„UserVideosPage

#### 3.1 å®ç°æ•°æ®åŠ è½½
**æ–‡ä»¶ä½ç½®**ï¼š`lib/views/bilibili/user_videos_page.dart`

ä¿®æ”¹ `_loadVideos` æ–¹æ³•ï¼š
```dart
Future<void> _loadVideos({bool loadMore = false}) async {
  if (_isLoading || (!loadMore && !_hasMore)) return;
  
  setState(() {
    _isLoading = true;
    _errorMessage = null;
  });

  try {
    final page = loadMore ? _currentPage + 1 : 1;
    
    // è°ƒç”¨APIè·å–UPä¸»è§†é¢‘
    final videos = await _apiService.getUploaderVideos(
      mid: widget.mid,
      page: page,
      pageSize: 20,
    );
    
    if (mounted) {
      setState(() {
        if (loadMore) {
          _videos = [...?_videos, ...videos];
          _currentPage = page;
        } else {
          _videos = videos;
          _currentPage = 1;
        }
        _hasMore = videos.length >= 20;
        _isLoading = false;
      });
    }
  } catch (e) {
    if (mounted) {
      setState(() {
        _isLoading = false;
        _errorMessage = e.toString();
      });
    }
  }
}
```

### ç¬¬å››é˜¶æ®µï¼šé›†æˆåˆ°ç°æœ‰åŠŸèƒ½

#### 4.1 åœ¨æ’­æ”¾æ—¶å­˜å‚¨UPä¸»ä¿¡æ¯
**æ–‡ä»¶ä½ç½®**ï¼š`lib/services/player_provider.dart`

åœ¨ `playSong` æ–¹æ³•ä¸­ï¼Œä»è§†é¢‘ä¿¡æ¯è·å–UPä¸»æ•°æ®å¹¶å­˜å‚¨ï¼š
```dart
// å¯¹äºBilibiliæ­Œæ›²ï¼Œå­˜å‚¨UPä¸»ä¿¡æ¯
if (song.source == 'bilibili' && song.bvid != null) {
  try {
    final videoDetails = await _bilibiliApiService.getVideoDetails(song.bvid!);
    final updatedSong = song.copyWith(
      uploaderMid: videoDetails.owner.mid,
      uploaderName: Value(videoDetails.owner.name),
      uploaderFace: Value(videoDetails.owner.face),
    );
    await MusicDatabase.database.updateSong(updatedSong);
  } catch (e) {
    // é™é»˜å¤±è´¥
  }
}
```

#### 4.2 ä¿®å¤"æŸ¥çœ‹åˆ¶ä½œäººå‘˜"è·³è½¬
**æ–‡ä»¶ä½ç½®**ï¼š
- `lib/views/bilibili/favorite_detail_page.dart`
- `lib/views/bilibili/favorites_page.dart`

favorites_page.dartä¸­çš„ä¿®æ”¹ï¼š
```dart
void _viewSearchSongCreator(db.Song song) {
  // æ£€æŸ¥æ˜¯å¦æœ‰UPä¸»ä¿¡æ¯
  if (song.uploaderMid != null && song.uploaderMid! > 0) {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => UserVideosPage(
          mid: song.uploaderMid!,
          userName: song.uploaderName ?? song.artist ?? 'UPä¸»',
          userAvatar: song.uploaderFace,
        ),
      ),
    );
  } else {
    // å¦‚æœæ²¡æœ‰midï¼Œå°è¯•ä»å½“å‰è§†é¢‘è·å–
    _fetchAndNavigateToCreator(song);
  }
}

Future<void> _fetchAndNavigateToCreator(db.Song song) async {
  if (song.bvid == null) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('æ— æ³•è·å–UPä¸»ä¿¡æ¯')),
    );
    return;
  }
  
  try {
    final videoDetails = await _apiService.getVideoDetails(song.bvid!);
    
    if (mounted) {
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => UserVideosPage(
            mid: videoDetails.owner.mid,
            userName: videoDetails.owner.name,
            userAvatar: videoDetails.owner.face,
          ),
        ),
      );
    }
  } catch (e) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('è·å–UPä¸»ä¿¡æ¯å¤±è´¥: $e')),
      );
    }
  }
}
```

## ğŸ”„ å¼€å‘æµç¨‹

1. **ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¿ç§»**
   - ä¿®æ”¹ database.dart
   - å¢åŠ æ•°æ®åº“ç‰ˆæœ¬å·
   - æµ‹è¯•è¿ç§»æ˜¯å¦æ­£å¸¸

2. **ç¬¬äºŒæ­¥ï¼šAPIå®ç°**
   - åœ¨ api_service.dart ä¸­å®ç° getUploaderVideos
   - ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯APIè°ƒç”¨
   - æµ‹è¯•åˆ†é¡µå’Œé”™è¯¯å¤„ç†

3. **ç¬¬ä¸‰æ­¥ï¼šUIå®Œå–„**
   - å®Œå–„ UserVideosPage çš„æ•°æ®åŠ è½½
   - æµ‹è¯•åˆ—è¡¨æ˜¾ç¤ºå’Œåˆ†é¡µ

4. **ç¬¬å››æ­¥ï¼šé›†æˆæµ‹è¯•**
   - ä»æ”¶è—å¤¹ç‚¹å‡»"æŸ¥çœ‹åˆ¶ä½œäººå‘˜"
   - éªŒè¯è·³è½¬å’Œæ•°æ®åŠ è½½
   - æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**ï¼šå¿…é¡»è°¨æ…å¤„ç†ï¼Œé¿å…æ•°æ®ä¸¢å¤±
2. **APIé™æµ**ï¼šBilibili APIæœ‰è°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œéœ€è¦å¤„ç†429é”™è¯¯
3. **ç¼“å­˜ç­–ç•¥**ï¼šè€ƒè™‘ç¼“å­˜UPä¸»è§†é¢‘åˆ—è¡¨ï¼Œå‡å°‘APIè°ƒç”¨
4. **é”™è¯¯å¤„ç†**ï¼šç½‘ç»œé”™è¯¯ã€UPä¸»ä¸å­˜åœ¨ç­‰æƒ…å†µ
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§é‡è§†é¢‘æ—¶çš„åˆ—è¡¨æ€§èƒ½

## ğŸ“… é¢„è®¡æ—¶é—´

- æ•°æ®åº“æ‰©å±•ï¼š30åˆ†é’Ÿ
- APIå®ç°ï¼š1å°æ—¶
- UIå®Œå–„ï¼š30åˆ†é’Ÿ
- é›†æˆæµ‹è¯•ï¼š30åˆ†é’Ÿ
- **æ€»è®¡**ï¼šçº¦2.5å°æ—¶

## âœ… éªŒæ”¶æ ‡å‡†

1. ç‚¹å‡»æ­Œæ›²èœå•çš„"æŸ¥çœ‹åˆ¶ä½œäººå‘˜"èƒ½æ­£ç¡®è·³è½¬
2. UPä¸»é¡µé¢èƒ½æ­£ç¡®æ˜¾ç¤ºè§†é¢‘åˆ—è¡¨
3. æ”¯æŒä¸‹æ‹‰åˆ·æ–°å’Œä¸Šæ‹‰åŠ è½½æ›´å¤š
4. ç‚¹å‡»è§†é¢‘èƒ½è·³è½¬åˆ°è§†é¢‘è¯¦æƒ…é¡µ
5. é”™è¯¯æƒ…å†µæœ‰å‹å¥½æç¤º

## ğŸ¨ UIç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† UPä¸»åç§°          [å¤´åƒ]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  è§†é¢‘æ ‡é¢˜1              â”‚
â”‚  â”‚å°é¢â”‚  å‘å¸ƒæ—¶é—´                â”‚
â”‚  â””â”€â”€â”€â”€â”˜                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”  è§†é¢‘æ ‡é¢˜2              â”‚
â”‚  â”‚å°é¢â”‚  å‘å¸ƒæ—¶é—´                â”‚
â”‚  â””â”€â”€â”€â”€â”˜                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  ...                            â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
