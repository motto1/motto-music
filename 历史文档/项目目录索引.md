# LZF Music é¡¹ç›®ç›®å½•ç´¢å¼•

> **é¡¹ç›®ç®€ä»‹**ï¼šåŸºäº Flutter å¼€å‘çš„è·¨å¹³å°éŸ³ä¹æ’­æ”¾å™¨ï¼Œæ”¯æŒæœ¬åœ°éŸ³ä¹ã€Bilibili éŸ³é¢‘æ’­æ”¾ã€WebDAV äº‘åŒæ­¥ç­‰åŠŸèƒ½ã€‚è®¾è®¡é£æ ¼å‚è€ƒ Apple Musicã€‚

---

## ğŸ“ æ ¹ç›®å½•ç»“æ„

### æ ¸å¿ƒé…ç½®æ–‡ä»¶
- `pubspec.yaml` - Flutter é¡¹ç›®ä¾èµ–é…ç½®
- `README.md` - é¡¹ç›®è¯´æ˜æ–‡æ¡£
- `LICENSE` - Apache 2.0 å¼€æºåè®®
- `CLAUDE.md` - AI è¾…åŠ©å¼€å‘æŒ‡ä»¤æ–‡æ¡£
- `analysis_options.yaml` - Dart ä»£ç åˆ†æé…ç½®

### å¹³å°ç›®å½•
- `android/` - Android å¹³å°é…ç½®ä¸æ„å»ºæ–‡ä»¶
- `ios/` - iOS å¹³å°é…ç½®ä¸æ„å»ºæ–‡ä»¶
- `windows/` - Windows å¹³å°é…ç½®ä¸æ„å»ºæ–‡ä»¶
- `linux/` - Linux å¹³å°é…ç½®ä¸æ„å»ºæ–‡ä»¶
- `macos/` - macOS å¹³å°é…ç½®ä¸æ„å»ºæ–‡ä»¶
- `web/` - Web å¹³å°èµ„æºæ–‡ä»¶

### èµ„æºç›®å½•
- `assets/` - åº”ç”¨èµ„æºæ–‡ä»¶
  - `fonts/` - è‡ªå®šä¹‰å­—ä½“ï¼ˆSF Iconsï¼‰
  - `icons/` - åº”ç”¨å›¾æ ‡
  - `windows/icons/` - Windows å¹³å°å›¾æ ‡

### æ–‡æ¡£ç›®å½•
- `doc/` - é¡¹ç›®æ–‡æ¡£ä¸æˆªå›¾
  - `images/` - åº”ç”¨æˆªå›¾å±•ç¤º

### å¼€å‘ç›®å½•
- `test/` - å•å…ƒæµ‹è¯•æ–‡ä»¶
- `build/` - æ„å»ºè¾“å‡ºç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `.dart_tool/` - Dart å·¥å…·ç¼“å­˜ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `.git/` - Git ç‰ˆæœ¬æ§åˆ¶
- `.github/workflows/` - GitHub Actions CI/CD é…ç½®
- `.idea/` - IntelliJ IDEA é¡¹ç›®é…ç½®

### å‚è€ƒé¡¹ç›®
- `BBPlayer-dev/` - BBPlayer å‚è€ƒé¡¹ç›®ï¼ˆReact Native å®ç°ï¼‰

---

## ğŸ“± lib/ æºä»£ç ç›®å½•

### ğŸ¯ å…¥å£æ–‡ä»¶
- `main.dart` - åº”ç”¨å…¥å£ï¼Œåˆå§‹åŒ– MediaKitã€æ•°æ®åº“ã€ä¸»é¢˜ã€å¹³å°ç®¡ç†å™¨ï¼Œ**æ³¨å…¥å…¨å±€ ExpandablePlayer å’Œåº•éƒ¨å¯¼èˆªæ **ï¼ˆé€šè¿‡ Overlayï¼‰

### ğŸ¨ animations/ - åŠ¨ç”»æ•ˆæœ
- `card_expand_animation.dart` - å¡ç‰‡å±•å¼€åŠ¨ç”»
- `card_expand_route.dart` - å¡ç‰‡å±•å¼€è·¯ç”±è¿‡æ¸¡

### ğŸ”§ contants/ - å¸¸é‡å®šä¹‰
- `app_contants.dart` - åº”ç”¨å…¨å±€å¸¸é‡é…ç½®

### ğŸ’¾ database/ - æ•°æ®åº“å±‚
- `database.dart` - Drift æ•°æ®åº“å®šä¹‰ï¼ˆéŸ³ä¹ã€æ’­æ”¾åˆ—è¡¨ã€æ’­æ”¾å†å²ï¼‰
- `database.g.dart` - æ•°æ®åº“ä»£ç ç”Ÿæˆæ–‡ä»¶

### ğŸ“¦ models/ - æ•°æ®æ¨¡å‹

#### models/bilibili/ - Bilibili æ•°æ®æ¨¡å‹
- `favorite.dart` / `favorite.g.dart` - æ”¶è—å¤¹æ¨¡å‹
- `user.dart` / `user.g.dart` - ç”¨æˆ·ä¿¡æ¯æ¨¡å‹
- `video.dart` / `video.g.dart` - è§†é¢‘ä¿¡æ¯æ¨¡å‹
- `search_strategy.dart` - æœç´¢ç­–ç•¥å®šä¹‰

#### models/lyrics/ - æ­Œè¯æ•°æ®æ¨¡å‹
- `lyric_models.dart` - æ­Œè¯æ•°æ®ç»“æ„
- `netease_models.dart` - ç½‘æ˜“äº‘éŸ³ä¹æ­Œè¯ API æ¨¡å‹

### ğŸ–¥ï¸ platform/ - å¹³å°ç®¡ç†
- `desktop_manager.dart` - æ¡Œé¢å¹³å°ç®¡ç†ï¼ˆçª—å£ã€æ‰˜ç›˜ã€æ ‡é¢˜æ ï¼‰
- `mobile_manager.dart` - ç§»åŠ¨å¹³å°ç®¡ç†ï¼ˆéŸ³é¢‘æœåŠ¡ã€åå°æ’­æ”¾ï¼‰

### ğŸ§­ router/ - è·¯ç”±ç®¡ç†
- `router.dart` - è·¯ç”±é…ç½®
- `route_observer.dart` - è·¯ç”±è§‚å¯Ÿå™¨ï¼ˆé¡µé¢ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼‰

### ğŸ”Œ services/ - ä¸šåŠ¡æœåŠ¡å±‚

#### æ ¸å¿ƒæœåŠ¡
- `audio_player_service.dart` - éŸ³é¢‘æ’­æ”¾æ ¸å¿ƒæœåŠ¡ï¼ˆMediaKit å°è£…ï¼‰
- `audio_loader_service.dart` - éŸ³é¢‘åŠ è½½æœåŠ¡ï¼ˆæœ¬åœ°/Bilibili éŸ³é¢‘æºï¼‰
- `player_provider.dart` - æ’­æ”¾å™¨çŠ¶æ€ç®¡ç†ï¼ˆProviderï¼‰
- `theme_provider.dart` - ä¸»é¢˜ç®¡ç†æœåŠ¡
- `music_import_service.dart` - éŸ³ä¹å¯¼å…¥æœåŠ¡
- `webdav_service.dart` - WebDAV äº‘åŒæ­¥æœåŠ¡

#### services/bilibili/ - Bilibili æœåŠ¡
- `api_client.dart` - HTTP å®¢æˆ·ç«¯å°è£…
- `api_service.dart` - Bilibili API æ¥å£å°è£…
- `login_service.dart` - ç™»å½•æœåŠ¡ï¼ˆäºŒç»´ç ç™»å½•ï¼‰
- `cookie_manager.dart` - Cookie ç®¡ç†
- `wbi_signer.dart` - WBI ç­¾åç®—æ³•ï¼ˆAPI é‰´æƒï¼‰
- `stream_service.dart` - è§†é¢‘æµè§£ææœåŠ¡
- `audio_cache_service.dart` - éŸ³é¢‘ç¼“å­˜æœåŠ¡
- `url_parser_service.dart` - URL è§£ææœåŠ¡
- `bilibili_exception.dart` - å¼‚å¸¸å®šä¹‰

#### services/lyrics/ - æ­Œè¯æœåŠ¡
- `lyric_service.dart` - æ­Œè¯ç®¡ç†æœåŠ¡ï¼ˆåŠ è½½ã€æœç´¢ã€ä¿å­˜ï¼‰
- `netease_api.dart` - ç½‘æ˜“äº‘éŸ³ä¹æ­Œè¯ API

### ğŸ’¿ storage/ - æœ¬åœ°å­˜å‚¨
- `player_state_storage.dart` - æ’­æ”¾å™¨çŠ¶æ€æŒä¹…åŒ–

### ğŸ› ï¸ utils/ - å·¥å…·ç±»
- `platform_utils.dart` - å¹³å°åˆ¤æ–­å·¥å…·
- `bilibili_utils.dart` - Bilibili å·¥å…·å‡½æ•°
- `bilibili_id_converter.dart` - BV/AV å·è½¬æ¢
- `lyric_parser.dart` - æ­Œè¯è§£æå™¨ï¼ˆLRC/TTMLï¼‰
- `theme_utils.dart` - ä¸»é¢˜å·¥å…·
- `scroll_utils.dart` - æ»šåŠ¨å·¥å…·
- `common_utils.dart` - é€šç”¨å·¥å…·å‡½æ•°

### ğŸ–¼ï¸ views/ - é¡µé¢è§†å›¾

#### ä¸»é¡µé¢
- `home_page_desktop.dart` - æ¡Œé¢ç«¯ä¸»é¡µï¼ˆä¾§è¾¹æ å¸ƒå±€ï¼‰
- `home_page_mobile.dart` - ç§»åŠ¨ç«¯ä¸»é¡µï¼ˆæ¥æ”¶å…¨å±€ MenuManagerï¼Œçº¯å†…å®¹å±•ç¤ºï¼‰
- `home_view.dart` - é¦–é¡µè§†å›¾
- `now_playing_screen.dart` - æ­£åœ¨æ’­æ”¾é¡µé¢ï¼ˆå…¨å±æ’­æ”¾ç•Œé¢ï¼‰

#### éŸ³ä¹åº“é¡µé¢
- `library_view.dart` - æœ¬åœ°éŸ³ä¹åº“
- `favorites_view.dart` - å–œæ¬¢çš„éŸ³ä¹
- `playlists_view.dart` - æ’­æ”¾åˆ—è¡¨
- `recently_played_view.dart` - æœ€è¿‘æ’­æ”¾ï¼ˆ**å·²å¼ƒç”¨**ï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
- `recently_played_detail_page.dart` - æœ€è¿‘æ’­æ”¾ï¼ˆç½‘æ ¼è§†å›¾ï¼Œé›†æˆç»Ÿä¸€å¯å±•å¼€æ’­æ”¾å™¨ï¼Œ**æ¨èä½¿ç”¨**ï¼‰

#### views/bilibili/ - Bilibili åŠŸèƒ½é¡µé¢
- `favorites_page.dart` - Bilibili æ”¶è—å¤¹åˆ—è¡¨
- `favorite_detail_page.dart` - æ”¶è—å¤¹è¯¦æƒ…
- `global_search_page.dart` - å…¨å±€æœç´¢é¡µ
- `global_search_result_page.dart` - æœç´¢ç»“æœé¡µ
- `login_page.dart` - ç™»å½•é¡µé¢
- `user_videos_page.dart` - UP ä¸»è§†é¢‘åˆ—è¡¨
- `video_detail_page.dart` - è§†é¢‘è¯¦æƒ…é¡µ

#### views/settings/ - è®¾ç½®é¡µé¢
- `settings_page.dart` - è®¾ç½®ä¸»é¡µ
- `storage_setting_page.dart` - å­˜å‚¨è®¾ç½®é¡µ

### ğŸ§© widgets/ - UI ç»„ä»¶

#### æ ¸å¿ƒç»„ä»¶
- `mini_player.dart` - è¿·ä½ æ’­æ”¾å™¨ï¼ˆåº•éƒ¨æ’­æ”¾æ¡ï¼Œå·²è¢«å¯å±•å¼€æ’­æ”¾å™¨å–ä»£ï¼‰
- `expandable_player.dart` - å¯å±•å¼€æ’­æ”¾å™¨å®¹å™¨ï¼ˆApple Music é£æ ¼ï¼Œæ”¯æŒæ‹–æ‹½å±•å¼€/æ”¶èµ·ï¼‰
- `expandable_player_content.dart` - å¯å±•å¼€æ’­æ”¾å™¨å†…å®¹ï¼ˆé›†æˆæ­Œè¯ã€å°é¢ã€æ§åˆ¶æŒ‰é’®ï¼‰
- `music_control_panel.dart` - éŸ³ä¹æ§åˆ¶é¢æ¿
- `music_list_view.dart` - éŸ³ä¹åˆ—è¡¨è§†å›¾
- `music_list_header.dart` - éŸ³ä¹åˆ—è¡¨å¤´éƒ¨
- `now_playing_screen.dart` - æ­£åœ¨æ’­æ”¾å±å¹•
- `custom_drawer.dart` - è‡ªå®šä¹‰ä¾§è¾¹æ 

#### æ­Œè¯ç»„ä»¶
- `lyrics_view.dart` - æ­Œè¯è§†å›¾
- `karaoke_lyrics_view.dart` - å¡æ‹‰ OK æ­Œè¯è§†å›¾
- `widgets/lyrics/` - æ­Œè¯ç›¸å…³ç»„ä»¶
  - `edit_lyrics_dialog.dart` - ç¼–è¾‘æ­Œè¯å¯¹è¯æ¡†
  - `lyrics_menu.dart` - æ­Œè¯èœå•
  - `lyric_offset_dialog.dart` - æ­Œè¯åç§»è°ƒæ•´
  - `manual_search_lyrics_dialog.dart` - æ‰‹åŠ¨æœç´¢æ­Œè¯

#### UI å·¥å…·ç»„ä»¶
- `frosted_container.dart` - æ¯›ç»ç’ƒå®¹å™¨
- `themed_background.dart` - ä¸»é¢˜èƒŒæ™¯
- `page_header.dart` - é¡µé¢å¤´éƒ¨
- `slider_custom.dart` - è‡ªå®šä¹‰æ»‘å—
- `scrolling_text.dart` - æ»šåŠ¨æ–‡æœ¬
- `sf_icon.dart` - SF Icons å›¾æ ‡
- `resolution_display.dart` - åˆ†è¾¨ç‡æ˜¾ç¤º
- `song_action_menu.dart` - æ­Œæ›²æ“ä½œèœå•
- `toggleable_popup_menu.dart` - å¯åˆ‡æ¢å¼¹å‡ºèœå•

#### äº¤äº’ç»„ä»¶
- `keyboard_handler.dart` - é”®ç›˜äº‹ä»¶å¤„ç†
- `show_aware_page.dart` - é¡µé¢æ˜¾ç¤ºæ„ŸçŸ¥
- `music_import_dialog.dart` - éŸ³ä¹å¯¼å…¥å¯¹è¯æ¡†
- `lzf_dialog.dart` - è‡ªå®šä¹‰å¯¹è¯æ¡†
- `lzf_toast.dart` - è‡ªå®šä¹‰æç¤º

---

## ğŸ§ª test/ æµ‹è¯•ç›®å½•
- `audio_loader_test.dart` - éŸ³é¢‘åŠ è½½æµ‹è¯•
- `bilibili_utils_test.dart` - Bilibili å·¥å…·æµ‹è¯•
- `url_parser_test.dart` - URL è§£ææµ‹è¯•
- `wbi_signer_test.dart` - WBI ç­¾åæµ‹è¯•

---

## ğŸ“„ é¡¹ç›®æ–‡æ¡£
- `Phase1_å®ŒæˆæŠ¥å‘Š.md` - ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š
- `Phase2_å®ŒæˆæŠ¥å‘Š.md` - ç¬¬äºŒé˜¶æ®µå®ŒæˆæŠ¥å‘Š
- `Phase3_å®ŒæˆæŠ¥å‘Š.md` - ç¬¬ä¸‰é˜¶æ®µå®ŒæˆæŠ¥å‘Š
- `Phase4_å®ŒæˆæŠ¥å‘Š.md` - ç¬¬å››é˜¶æ®µå®ŒæˆæŠ¥å‘Š
- `Phase5_æ­Œè¯åŠŸèƒ½å®ŒæˆæŠ¥å‘Š.md` - æ­Œè¯åŠŸèƒ½å®ŒæˆæŠ¥å‘Š
- `BBPlayer_è¿ç§»è®¡åˆ’.md` - BBPlayer è¿ç§»è®¡åˆ’
- `æœ¬åœ°æ”¶è—å¤¹åŠŸèƒ½å®ç°æŠ¥å‘Š.md` - æœ¬åœ°æ”¶è—å¤¹åŠŸèƒ½æŠ¥å‘Š
- `æ·»åŠ åˆ°æ”¶è—å¤¹åŠŸèƒ½å®ç°æŠ¥å‘Š.md` - æ·»åŠ æ”¶è—å¤¹åŠŸèƒ½æŠ¥å‘Š
- `æ­Œè¯æ¥æºä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` - æ­Œè¯ä¼˜åŒ–æŠ¥å‘Š
- `æŸ¥çœ‹åˆ¶ä½œäººå‘˜åŠŸèƒ½å®ç°è®¡åˆ’.md` - åˆ¶ä½œäººå‘˜åŠŸèƒ½è®¡åˆ’
- `è§†é¢‘æœç´¢404é—®é¢˜è¯Šæ–­æŠ¥å‘Š.md` - é—®é¢˜è¯Šæ–­æŠ¥å‘Š
- `è§†é¢‘æœç´¢404é—®é¢˜ä¿®å¤æ€»ç»“.md` - é—®é¢˜ä¿®å¤æ€»ç»“
- `BVå·å¤§å°å†™é—®é¢˜ä¿®å¤æŠ¥å‘Š.md` - BV å·é—®é¢˜ä¿®å¤æŠ¥å‘Š

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. éŸ³é¢‘æ’­æ”¾æ ¸å¿ƒ
- **MediaKit æ’­æ”¾å¼•æ“**ï¼š`audio_player_service.dart`
- **éŸ³é¢‘æºåŠ è½½**ï¼š`audio_loader_service.dart`ï¼ˆæ”¯æŒæœ¬åœ°/Bilibiliï¼‰
- **æ’­æ”¾çŠ¶æ€ç®¡ç†**ï¼š`player_provider.dart`
- **åå°æ’­æ”¾**ï¼š`mobile_manager.dart`ï¼ˆAndroid Audio Serviceï¼‰

### 2. Bilibili é›†æˆ
- **ç™»å½•è®¤è¯**ï¼šäºŒç»´ç ç™»å½•ã€Cookie ç®¡ç†ã€WBI ç­¾å
- **è§†é¢‘è§£æ**ï¼šBV/AV å·è½¬æ¢ã€è§†é¢‘æµè§£æã€éŸ³é¢‘æå–
- **æ”¶è—å¤¹ç®¡ç†**ï¼šæ”¶è—å¤¹åˆ—è¡¨ã€è¯¦æƒ…ã€è§†é¢‘æ’­æ”¾
- **æœç´¢åŠŸèƒ½**ï¼šå…¨å±€æœç´¢ã€UP ä¸»è§†é¢‘æœç´¢

### 3. æ­Œè¯ç³»ç»Ÿ
- **æ ¼å¼æ”¯æŒ**ï¼šLRCã€TTMLï¼ˆé€å­—æ­Œè¯ï¼‰
- **æ­Œè¯æ¥æº**ï¼šå†…åµŒæ­Œè¯ã€æœ¬åœ°æ–‡ä»¶ã€ç½‘æ˜“äº‘ API
- **æ­Œè¯ç¼–è¾‘**ï¼šæ‰‹åŠ¨ç¼–è¾‘ã€åç§»è°ƒæ•´ã€åœ¨çº¿æœç´¢

### 4. æœ¬åœ°éŸ³ä¹åº“
- **æ ¼å¼æ”¯æŒ**ï¼šMP3ã€M4Aã€WAVã€FLAC
- **å…ƒæ•°æ®è¯»å–**ï¼šæ ‡é¢˜ã€è‰ºæœ¯å®¶ã€ä¸“è¾‘ã€å°é¢
- **æ•°æ®åº“ç®¡ç†**ï¼šDrift ORMã€æ’­æ”¾å†å²ã€æ”¶è—å¤¹

### 5. äº‘åŒæ­¥
- **WebDAV æ”¯æŒ**ï¼šè¿æ¥ç§æœ‰äº‘ã€éŸ³ä¹åŒæ­¥

### 6. UI/UX
- **Apple Music é£æ ¼**ï¼šæ¯›ç»ç’ƒæ•ˆæœã€æµç•…åŠ¨ç”»
- **å“åº”å¼è®¾è®¡**ï¼šæ¡Œé¢/ç§»åŠ¨ç«¯è‡ªé€‚åº”
- **ä¸»é¢˜ç³»ç»Ÿ**ï¼šäº®è‰²/æš—è‰²ä¸»é¢˜ã€è‡ªå®šä¹‰é¢œè‰²

---

## ğŸ”‘ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šFlutter 3.3+
- **çŠ¶æ€ç®¡ç†**ï¼šProvider
- **æ•°æ®åº“**ï¼šDrift (SQLite)
- **éŸ³é¢‘æ’­æ”¾**ï¼šMediaKit
- **ç½‘ç»œè¯·æ±‚**ï¼šDioã€HTTP
- **å¹³å°é›†æˆ**ï¼š
  - æ¡Œé¢ï¼šwindow_managerã€bitsdojo_windowã€tray_manager
  - ç§»åŠ¨ï¼šaudio_service
- **UI ç»„ä»¶**ï¼šflutter_acrylicï¼ˆæ¯›ç»ç’ƒï¼‰ã€cached_network_image

---

## ğŸ“ å¼€å‘è§„èŒƒ

1. **UI è®¾è®¡æ ‡å‡†**ï¼šå‚è€ƒ Apple iOS å’Œ Apple Music
2. **æ ¸å¿ƒè§†å›¾å‘½å**ï¼š
   - `FavoritesView` - å–œæ¬¢çš„éŸ³ä¹
   - `LibraryView` - æœ¬åœ°éŸ³ä¹åº“
   - `BilibiliFavoritesPage` - Bilibili éŸ³ä¹åº“
3. **å¹³å°ä¼˜åŒ–**ï¼šä¸“æ³¨ Android å¹³å°ä¼˜åŒ–
4. **è°ƒè¯•ä¼˜å…ˆ**ï¼šé‡åˆ°é—®é¢˜ä¼˜å…ˆæ·»åŠ è°ƒè¯•ä¿¡æ¯
5. **å…¨å±€ç»„ä»¶æ¶æ„**ï¼š
   - **ExpandablePlayer**ï¼šé€šè¿‡ Overlay å…¨å±€æ³¨å…¥ï¼Œæ‰€æœ‰é¡µé¢ï¼ˆåŒ…æ‹¬ Navigator.pushï¼‰å‡å¯ä½¿ç”¨
   - **åº•éƒ¨å¯¼èˆªæ **ï¼šé€šè¿‡ Overlay å…¨å±€æ³¨å…¥ï¼Œåœ¨æ‰€æœ‰é¡µé¢å¯è§
   - **é¡µé¢åº•éƒ¨å®‰å…¨åŒºåŸŸ**ï¼šæ‰€æœ‰é¡µé¢åº•éƒ¨é¢„ç•™ 164px (84px æ’­æ”¾å™¨ + 80px å¯¼èˆªæ )
6. **Android è¿”å›é”®å¤„ç†æœºåˆ¶**ï¼š
   - **å…¨å±€ä¼˜å…ˆçº§**ï¼šæ’­æ”¾å™¨å…¨å±æ—¶ï¼ˆpercentage >= 0.9ï¼‰ï¼Œç³»ç»Ÿè¿”å›é”®ä¼˜å…ˆç¼©å°æ’­æ”¾å™¨
   - **å®ç°æ–¹å¼**ï¼šé€šè¿‡ `HomePageWrapperState.globalPlayerKey` è®¿é—®å…¨å±€æ’­æ”¾å™¨çŠ¶æ€
   - **åº”ç”¨é¡µé¢**ï¼šæ‰€æœ‰ä½¿ç”¨ `Navigator.push()` æ‰“å¼€çš„é¡µé¢éƒ½éœ€å®ç°æ­¤é€»è¾‘
   - **æ ‡å‡†æ¨¡å¼**ï¼š
     ```dart
     PopScope(
       canPop: false,
       onPopInvokedWithResult: (didPop, result) {
         if (!didPop) {
           // 1. æ£€æŸ¥æ’­æ”¾å™¨æ˜¯å¦å…¨å±
           final playerKey = HomePageWrapperState.globalPlayerKey;
           final playerState = playerKey?.currentState;
           final percentage = playerState?.percentage ?? -1;
           
           if (playerState != null && percentage >= 0.9) {
             // æ’­æ”¾å™¨å…¨å±ï¼Œä¼˜å…ˆç¼©å°æ’­æ”¾å™¨
             playerState.animateToState(false);
             return;
           }
           
           // 2. æ’­æ”¾å™¨éå…¨å±ï¼Œæ‰§è¡Œæ­£å¸¸è¿”å›é€»è¾‘
           Navigator.of(context).pop();
         }
       },
       child: ...,
     )
     ```

---

## ğŸ“ æœ€è¿‘æ›´æ–°æ—¥å¿—

### 2025-11-12 Bug ä¿®å¤ä¸åŠŸèƒ½å¢å¼º
1. **ğŸ”§ ä¿®å¤æ­Œè¯åç§»é‡åŠŸèƒ½**ï¼š
   - ä¿®å¤ `KaraokeLyricsView` ç»„ä»¶æœªåº”ç”¨ `offset` å‚æ•°çš„é—®é¢˜
   - æ·»åŠ  `offsetInSeconds` å‚æ•°ï¼Œæ”¯æŒæ­£è´Ÿåç§»é‡è°ƒæ•´ï¼ˆ-5s åˆ° +5sï¼‰
   - ä¿®æ”¹ `_updateCurrentLine` æ–¹æ³•ï¼Œæ­£ç¡®åº”ç”¨åç§»é‡åˆ°æ—¶é—´è®¡ç®—
   - ä¿®å¤ `expandable_player_content.dart`ï¼Œå°† `ParsedLrc.offset` ä¼ é€’ç»™æ­Œè¯ç»„ä»¶
   - **æ•ˆæœ**ï¼šè°ƒæ•´åç§»é‡åç«‹å³ç”Ÿæ•ˆï¼Œä¿å­˜åä¸‹æ¬¡æ’­æ”¾è‡ªåŠ¨åº”ç”¨

2. **ğŸµ å®ç°æ’­æ”¾åˆ—è¡¨æ‹–åŠ¨æ’åºåŠŸèƒ½**ï¼ˆApple Music é£æ ¼ï¼‰ï¼š
   - åœ¨ `PlayerProvider` ä¸­æ·»åŠ  `reorderPlaylist(oldIndex, newIndex)` æ–¹æ³•
   - å°†æ’­æ”¾åˆ—è¡¨ä» `ListView.builder` å‡çº§ä¸º `ReorderableListView.builder`
   - å®ç° Apple Music é£æ ¼çš„æ‹–åŠ¨åŠ¨ç”»æ•ˆæœï¼ˆç¼©æ”¾ 1.0â†’1.03 + é˜´å½± 0â†’8ï¼‰
   - è‡ªåŠ¨åŒæ­¥åŸå§‹æ’­æ”¾åˆ—è¡¨å’Œå½“å‰æ’­æ”¾ç´¢å¼•
   - æ”¯æŒæ‹–åŠ¨æ’åºåè‡ªåŠ¨ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨

3. **ğŸ¨ ä¼˜åŒ–æ’­æ”¾åˆ—è¡¨UIè®¾è®¡**ï¼ˆApple Music é£æ ¼ï¼‰ï¼š
   - âœ… **æ˜¾ç¤ºæ­Œæ›²å°é¢**ï¼š48x48pxï¼Œåœ†è§’6pxï¼Œæ”¯æŒæœ¬åœ°å’ŒBilibiliåŒé‡æ¥æº
   - âœ… **å°é¢æ˜¾ç¤ºé€»è¾‘**ï¼š
     - BilibiliéŸ³ä¹ï¼šæ£€æµ‹URLæ ¼å¼ï¼ˆhttp/httpsï¼‰ï¼Œä½¿ç”¨ `Image.network` åŠ è½½
     - æœ¬åœ°éŸ³ä¹ï¼šæ£€æµ‹æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨ `Image.file` åŠ è½½
     - ç»Ÿä¸€ä» `Song.albumArtPath` å­—æ®µè¯»å–ï¼ˆæ”¯æŒURLå’Œæ–‡ä»¶è·¯å¾„ä¸¤ç§æ ¼å¼ï¼‰
     - **ä¸­å¿ƒå‰ªè£**ï¼šç§»é™¤ Image çš„ width/height å‚æ•°ï¼Œä½¿ç”¨ `BoxFit.cover` å®ç°éæ­£æ–¹å½¢å›¾ç‰‡çš„ä¸­å¿ƒå‰ªè£ï¼ˆä¸å‹ç¼©ï¼‰
     - ç¼“å­˜ä¼˜åŒ–ï¼š`cacheWidth/Height: 144`ï¼ˆ3xåƒç´ æ¯”ä¼˜åŒ–ï¼‰
   - âœ… **å°é¢å ä½å›¾**ï¼šå°é¢åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºéŸ³ç¬¦å›¾æ ‡ï¼Œé¢œè‰²50%é€æ˜
   - âœ… **æ‹–åŠ¨æ‰‹æŸ„è®¾è®¡**ï¼šè‡ªå®šä¹‰4æ¡æ¨ªæ ï¼ˆ18x2pxï¼Œé—´è·3pxï¼‰ï¼Œæ”¾ç½®äºåˆ—è¡¨é¡¹å°¾éƒ¨ï¼Œé¢œè‰²30%é€æ˜
   - âœ… **æ­Œåé¢œè‰²**ï¼šçº¯ç™½è‰² (`Colors.white`)ï¼Œæ’­æ”¾ä¸­æ˜¾ç¤ºä¸»é¢˜è‰² + åŠ ç²—å­—ä½“
   - âœ… **è‰ºæœ¯å®¶é¢œè‰²**ï¼šä¸»é¢˜è‡ªé€‚åº”ï¼ˆæš—è‰²æ¨¡å¼50%é€æ˜ç™½è‰²ï¼Œäº®è‰²æ¨¡å¼50%é€æ˜é»‘è‰²ï¼‰
   - âœ… **ç§»é™¤æ—¶é•¿æ˜¾ç¤º**ï¼šç•Œé¢æ›´ç®€æ´ï¼Œç¬¦åˆç°ä»£éŸ³ä¹Appè®¾è®¡
   - âœ… **é•¿æŒ‰æ‹–åŠ¨**ï¼šé•¿æŒ‰å³ä¾§æ‹–åŠ¨æ‰‹æŸ„å³å¯è°ƒæ•´é¡ºåºï¼Œå¸¦æœ‰ç¼©æ”¾å’Œé˜´å½±åŠ¨ç”»

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `lib/widgets/karaoke_lyrics_view.dart` - æ·»åŠ  `offsetInSeconds` å‚æ•°å¹¶åº”ç”¨åˆ°æ—¶é—´è®¡ç®—
- `lib/widgets/expandable_player_content.dart` - ä¼ é€’åç§»é‡ã€å®ç°æ‹–åŠ¨æ’åºUIã€ä¼˜åŒ–åˆ—è¡¨é¡¹è®¾è®¡ã€æ·»åŠ  `_buildSongCover()` æ–¹æ³•
- `lib/services/player_provider.dart` - æ·»åŠ  `reorderPlaylist` æ–¹æ³•

**æŠ€æœ¯å®ç°è¦ç‚¹**ï¼š
```dart
// å°é¢æ˜¾ç¤ºé€»è¾‘ï¼ˆæ¨¡ä»¿æ’­æ”¾å™¨çš„ _buildAlbumArt æ–¹æ³•ï¼‰
// ğŸ”§ å…³é”®ï¼šç§»é™¤ Image çš„ width/height å‚æ•°ï¼Œè®©å›¾ç‰‡å¡«å……å¤–å±‚çš„ SizedBox å®¹å™¨
// é€šè¿‡ BoxFit.cover å®ç°ä¸­å¿ƒå‰ªè£ï¼Œä¸å‹ç¼©éæ­£æ–¹å½¢å›¾ç‰‡
Widget _buildSongCover(Song song, BuildContext context) {
  if (song.albumArtPath != null && song.albumArtPath!.isNotEmpty) {
    final albumArtPath = song.albumArtPath!;
    
    // Bilibili å°é¢ï¼šURL æ ¼å¼ï¼ˆhttp:// æˆ– https://ï¼‰
    if (albumArtPath.startsWith('http://') || albumArtPath.startsWith('https://')) {
      return Image.network(
        albumArtPath, 
        fit: BoxFit.cover, // ä¸­å¿ƒå‰ªè£
        cacheWidth: 144, 
        cacheHeight: 144
      );
    }
    
    // æœ¬åœ°å°é¢ï¼šæ–‡ä»¶è·¯å¾„
    final file = File(albumArtPath);
    if (file.existsSync()) {
      return Image.file(
        file, 
        fit: BoxFit.cover, // ä¸­å¿ƒå‰ªè£
        cacheWidth: 144, 
        cacheHeight: 144
      );
    }
  }
  
  return _buildPlaceholderCover(context); // å ä½å›¾
}

// å¤–å±‚å®¹å™¨ä½¿ç”¨ ClipRRect + SizedBox é™åˆ¶ä¸ºæ­£æ–¹å½¢
ClipRRect(
  borderRadius: BorderRadius.circular(6),
  child: SizedBox(
    width: 48,
    height: 48,
    child: _buildSongCover(song, context),
  ),
)
```

---

*æœ€åæ›´æ–°ï¼š2025-11-12*
