# 本地收藏夹功能实现报告

## 功能概述

实现了Bilibili音乐库的混合收藏夹功能，支持在线收藏夹和本地收藏夹共存。

## 核心改动

### 1. 视频详情页 (`video_detail_page.dart`)

#### 修改 `_createAndAddToFavorite()` 方法
- **之前**：调用B站API创建在线收藏夹
- **现在**：创建本地收藏夹，存储在本地数据库

**实现逻辑**：
1. 用户输入收藏夹名称和简介
2. 在本地数据库创建收藏夹（`isLocal: true`）
3. 自动获取视频的所有分P
4. 将每个分P作为独立歌曲添加到收藏夹
5. 每首歌曲关联到收藏夹（`bilibiliFavoriteId`）

**关键字段**：
- `remoteId`: 使用时间戳作为唯一ID
- `isLocal`: true（标记为本地收藏夹）
- `isAddedToLibrary`: true（显示在音乐库中）
- `mediaCount`: 分P数量

### 2. 收藏夹列表页 (`favorites_page.dart`)

#### 修改 `_loadFavorites()` 方法
- 同时加载在线收藏夹（`isLocal: false`）和本地收藏夹（`isLocal: true`）
- 两种收藏夹混合显示在同一列表

#### 新增 `_buildFavoriteCardContent()` 方法
- 使用 `FutureBuilder` 异步判断收藏夹类型
- 为本地收藏夹添加"本地"标签
- 区分图标：本地用音符图标，在线用视频图标
- 区分文案：本地显示"首歌曲"，在线显示"个视频"

### 3. 收藏夹详情页 (`favorite_detail_page.dart`)

#### 已有功能（无需修改）
- `_isLocalFavorite` 字段已存在
- `_loadLocalFavoriteSongs()` 方法已实现
- 自动根据 `isLocal` 字段加载对应数据

## 数据流程

### 创建本地收藏夹
```
视频详情页
  ↓
创建本地收藏夹（数据库）
  ↓
获取所有分P
  ↓
每个分P作为歌曲插入数据库
  ↓
关联到收藏夹（bilibiliFavoriteId）
```

### 显示混合收藏夹
```
Bilibili音乐库
  ↓
查询数据库（isAddedToLibrary = true）
  ↓
在线收藏夹（isLocal = false）+ 本地收藏夹（isLocal = true）
  ↓
混合显示，带标签区分
```

### 播放本地收藏夹
```
点击本地收藏夹
  ↓
收藏夹详情页
  ↓
从数据库查询关联歌曲（bilibiliFavoriteId）
  ↓
显示歌曲列表
  ↓
点击播放
```

## UI 变化

### 收藏夹列表
- **在线收藏夹**：无标签，视频图标，"X个视频"
- **本地收藏夹**：蓝色"本地"标签，音符图标，"X首歌曲"

### 创建对话框
- 标题改为"创建本地收藏夹"
- 提示改为"正在创建本地收藏夹..."
- 成功提示显示添加的歌曲数量

## 数据库结构

### BilibiliFavorites 表
```dart
remoteId: int          // 在线用B站ID，本地用时间戳
title: String          // 收藏夹名称
description: String?   // 简介
isLocal: bool          // true=本地，false=在线
isAddedToLibrary: bool // 是否显示在音乐库
mediaCount: int        // 歌曲/视频数量
```

### Songs 表
```dart
bilibiliFavoriteId: int?  // 关联到收藏夹
bvid: String?             // B站视频ID
cid: int?                 // 分P的CID
pageNumber: int?          // 分P序号
source: String            // 'bilibili'
```

## 测试要点

1. ✅ 创建本地收藏夹
2. ✅ 多P视频自动展开为多首歌曲
3. ✅ 本地收藏夹持久化（刷新不消失）
4. ✅ 在线和本地收藏夹混合显示
5. ✅ 本地收藏夹显示"本地"标签
6. ✅ 点击本地收藏夹正常播放

## 注意事项

1. **本地收藏夹不会同步到B站**
2. **在线收藏夹只读，不能在本地修改**
3. **本地收藏夹的歌曲需要网络播放（从B站获取音频流）**
4. **remoteId 使用时间戳，确保唯一性**
