{
  "symptom": {
    "description": "播放列表在插播操作后，出现两个歌曲同时高亮的现象。特别是当插播同一视频的不同分P时，旧的和新的分P都会显示高亮状态。",
    "error_message": null,
    "stack_trace": null,
    "frequency": "always",
    "user_impact": "用户无法区分当前实际播放的是哪首歌，视觉混淆，影响使用体验"
  },
  "root_cause": {
    "file": "lib/widgets/expandable_player_content.dart",
    "line_range": "2136-2166",
    "function": "_isSameSongForHighlight",
    "issue": "高亮判断逻辑的兜底分支过于宽松。当 bvid 相同但 cid/pageNumber 不同时，仍然返回 true，导致同一视频的不同分P被同时认为是'当前播放'。第 2161 行的 'return true' 应该只在精确匹配时返回。",
    "confidence": 0.95,
    "category": "logic_error"
  },
  "affected_files": [
    {
      "path": "lib/widgets/expandable_player_content.dart",
      "relevance": 1.0,
      "rationale": "包含高亮判断逻辑 _isSameSongForHighlight，是 bug 的直接来源",
      "change_type": "fix_target"
    },
    {
      "path": "lib/services/player_provider.dart",
      "relevance": 0.7,
      "rationale": "提供 currentSong 状态和 playlistNotifier，间接影响高亮判断的输入数据",
      "change_type": "reference_only"
    }
  ],
  "reproduction_steps": [
    "1. 播放一首来自 Bilibili 的歌曲（例如：BV1234567，分P=1）",
    "2. 点击插播功能，插入同一视频的另一个分P（BV1234567，分P=2）",
    "3. 打开播放列表查看",
    "4. 观察到两个分P同时显示高亮状态"
  ],
  "fix_hints": [
    {
      "description": "修复 _isSameSongForHighlight 的兜底逻辑",
      "approach": "将第 2161 行的 'return true' 改为 'return false'。仅在 bvid 相同时不应默认认为是同一首歌，必须 cid 或 pageNumber 也匹配才返回 true。如果都不匹配，说明是同一视频的不同分P，应返回 false。",
      "code_example": "// 修复前（第 2161 行）:\n// 兜底：仅 bvid 相同也认为是同一首内容\nreturn true;\n\n// 修复后:\n// 兜底：bvid 相同但 cid/pageNumber 都不匹配，说明是不同分P\nreturn false;",
      "risk": "low"
    },
    {
      "description": "可选：添加调试日志验证修复效果",
      "approach": "在 _isSameSongForHighlight 中添加 debugPrint，输出匹配结果和原因，便于验证修复后的行为是否正确。",
      "code_example": "debugPrint('[HighlightDebug] Comparing: current.id=${current.id}, song.id=${song.id}, '\n  'bvid=${current.bvid}==${song.bvid}, cid=${current.cid}==${song.cid}, '\n  'page=${current.pageNumber}==${song.pageNumber}, result=$result');",
      "risk": "low"
    }
  ],
  "dependencies": "Flutter ValueNotifier, Provider (播放列表状态更新机制)",
  "constraints": "修复必须保持与现有匹配逻辑的兼容性：优先 id 匹配，其次 bvid+cid，再次 bvid+pageNumber，最后才是兜底",
  "related_issues": [
    {
      "type": "similar_bug",
      "reference": "lib/services/player_provider.dart:1622-1658",
      "description": "_findSongIndexForQueue 使用类似的匹配逻辑，但其兜底返回 true 是合理的（查找索引时，bvid 相同即可认为找到）。_isSameSongForHighlight 的语义不同（精确判断是否播放中），因此兜底应返回 false"
    }
  ],
  "clarification_needs": [],
  "_metadata": {
    "timestamp": "2025-12-08T13:36:25.589Z",
    "bug_description": "目前的播放列表功能在插播等操作后，可能会出现两个歌曲同时在播放列表高亮的情况",
    "source": "cli-explore-agent",
    "diagnosis_angle": "state-management",
    "diagnosis_index": 1,
    "total_diagnoses": 2
  }
}
