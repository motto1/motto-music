{
  "summary": "修复播放列表高亮逻辑错误，避免同一视频的不同分P同时高亮。问题根源在于 _isSameSongForHighlight 函数的兜底逻辑过于宽松，将 bvid 相同但 cid/pageNumber 不同的歌曲也判定为同一首。修复方案为将兜底返回值从 true 改为 false。",
  "root_cause": "lib/widgets/expandable_player_content.dart:2161 - _isSameSongForHighlight 函数的兜底分支在 bvid 相同时直接返回 true，导致同一视频的不同分P被错误判定为'当前播放'，引发双高亮问题。",
  "strategy": "immediate_patch",
  "tasks": [
    {
      "id": "FIX1",
      "title": "修复播放列表高亮判断逻辑",
      "scope": "lib/widgets/expandable_player_content.dart",
      "action": "Fix",
      "description": "修复 _isSameSongForHighlight 函数的兜底逻辑，将第 2161 行的 'return true' 改为 'return false'，确保只有精确匹配的歌曲才被高亮。",
      "modification_points": [
        {
          "file": "lib/widgets/expandable_player_content.dart",
          "target": "_isSameSongForHighlight:2161",
          "change": "将兜底返回值从 'return true' 改为 'return false'"
        }
      ],
      "implementation": [
        "1. 打开 lib/widgets/expandable_player_content.dart",
        "2. 定位到第 2161 行的 'return true;' 语句（位于 _isSameSongForHighlight 函数末尾）",
        "3. 将其修改为 'return false;'",
        "4. 更新注释：将 '兜底：仅 bvid 相同也认为是同一首内容' 改为 '兜底：bvid 相同但 cid/pageNumber 都不匹配，说明是不同分P'",
        "5. 保存文件"
      ],
      "verification": [
        "播放 Bilibili 视频的某个分P，然后插播同一视频的另一分P，打开播放列表，确认只有一个分P高亮",
        "测试其他场景：播放不同视频、切换播放顺序，确认高亮状态正确",
        "检查调试日志（第 2341-2347 行），确认 isPlaying 值符合预期"
      ],
      "reference": {
        "pattern": "精确匹配模式",
        "files": [
          "lib/services/player_provider.dart:1622-1658"
        ],
        "examples": "_findSongIndexForQueue 使用类似逻辑但语义不同（查找索引允许宽松匹配），_isSameSongForHighlight 必须精确匹配"
      },
      "risk": "low"
    }
  ],
  "focus_paths": [
    "lib/widgets/expandable_player_content.dart"
  ],
  "test_strategy": {
    "scope": "smoke",
    "manual_verification": [
      "测试场景1：播放 BV1234567 分P1，插播 BV1234567 分P2，确认只有分P2高亮",
      "测试场景2：播放 BV1234567 分P1，添加 BV7890123 分P1 到队列，确认只有当前播放的歌曲高亮",
      "测试场景3：随机播放模式下切换歌曲，确认高亮状态跟随当前播放"
    ]
  },
  "rollback_plan": {
    "strategy": "git_revert",
    "steps": [
      "如果修复后出现新问题，执行 git revert 回退提交",
      "原始逻辑为第 2161 行 'return true;'"
    ]
  },
  "estimated_time": "10 minutes",
  "recommended_execution": "Agent",
  "severity": "Medium",
  "risk_level": "low",
  "_metadata": {
    "timestamp": "2025-12-08T13:36:25.589Z",
    "source": "direct-planning",
    "planning_mode": "direct",
    "diagnosis_angles": ["state-management", "event-handling"]
  }
}
