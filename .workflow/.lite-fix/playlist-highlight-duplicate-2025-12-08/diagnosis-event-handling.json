{
  "symptom": {
    "description": "插播操作后，播放列表的高亮状态未正确更新，导致多个歌曲同时高亮。特别是插播同一视频的不同分P时，原有分P的高亮状态未被清除。",
    "error_message": null,
    "stack_trace": null,
    "frequency": "always",
    "user_impact": "播放列表视觉状态混乱，用户无法识别当前播放歌曲"
  },
  "root_cause": {
    "file": "lib/widgets/expandable_player_content.dart",
    "line_range": "2336-2338",
    "function": "itemBuilder (playlist ReorderableListView)",
    "issue": "播放列表item构建时，使用 _isSameSongForHighlight 判断高亮状态。该函数的逻辑错误（兜底返回true）导致事件触发UI重建时，多个item被错误标记为isPlaying=true。问题根源在于判断逻辑而非事件处理流程。",
    "confidence": 0.85,
    "category": "logic_error"
  },
  "affected_files": [
    {
      "path": "lib/widgets/expandable_player_content.dart",
      "relevance": 1.0,
      "rationale": "包含播放列表的UI构建逻辑和高亮判断调用（第2338行），是事件响应的最终呈现层",
      "change_type": "fix_target"
    },
    {
      "path": "lib/services/player_provider.dart",
      "relevance": 0.8,
      "rationale": "插播操作 insertNext (第1798-1853行) 触发 playlistNotifier 更新，间接触发UI重建事件",
      "change_type": "reference_only"
    }
  ],
  "reproduction_steps": [
    "1. 播放Bilibili视频的某个分P",
    "2. 执行插播操作(insertNext)，插入同一视频的另一分P",
    "3. PlayerProvider._insertNextWithIndexMapping 更新 _playOrder 和 playlistNotifier",
    "4. playlistNotifier 触发 ValueListenableBuilder 重建播放列表UI",
    "5. itemBuilder 调用 _isSameSongForHighlight 判断每个item的高亮状态",
    "6. 由于判断逻辑错误，两个分P都返回true，导致双高亮"
  ],
  "fix_hints": [
    {
      "description": "修复 _isSameSongForHighlight 的bvid兜底逻辑",
      "approach": "与state-management诊断一致：将第2161行的 'return true' 改为 'return false'。这样事件触发UI重建时，只有真正匹配的歌曲会被高亮。",
      "code_example": "// lib/widgets/expandable_player_content.dart 第2161行\n// 修复前:\nreturn true;  // 兜底：仅 bvid 相同也认为是同一首内容\n\n// 修复后:\nreturn false; // 兜底：bvid相同但cid/page不同，说明是不同分P",
      "risk": "low"
    },
    {
      "description": "可选：验证事件流是否正确触发UI更新",
      "approach": "在 PlayerProvider._updatePlaylistNotifier (第137-147行) 和 itemBuilder (第2335行) 添加日志，确认插播后 playlistNotifier 正确触发了UI重建，且currentSong已更新。",
      "code_example": "// PlayerProvider._updatePlaylistNotifier\ndebugPrint('[Event] playlistNotifier 更新触发: currentSong.id=${_currentSong?.id}');\n\n// itemBuilder\ndebugPrint('[Event] Item[$index] 重建: song.id=${song.id}, isPlaying=$isPlaying');",
      "risk": "low"
    }
  ],
  "dependencies": "Flutter ValueNotifier 事件机制, Provider 状态传播",
  "constraints": "修复不应改变现有的事件触发流程，仅修正高亮判断逻辑",
  "related_issues": [
    {
      "type": "related_feature",
      "reference": "lib/services/player_provider.dart:137-147",
      "description": "_updatePlaylistNotifier 使用 addPostFrameCallback 延迟更新，避免同步修改导致断言。这个机制正确，不需要修改。"
    },
    {
      "type": "tech_debt",
      "reference": "lib/widgets/expandable_player_content.dart:2341-2347",
      "description": "调试日志仅打印前3个item，可能遗漏后续item的高亮状态问题。建议扩展日志范围或添加条件过滤（仅打印isPlaying=true的item）。"
    }
  ],
  "clarification_needs": [],
  "_metadata": {
    "timestamp": "2025-12-08T13:36:25.589Z",
    "bug_description": "目前的播放列表功能在插播等操作后，可能会出现两个歌曲同时在播放列表高亮的情况",
    "source": "cli-explore-agent",
    "diagnosis_angle": "event-handling",
    "diagnosis_index": 2,
    "total_diagnoses": 2
  }
}
